---
title: "Consulting Avian Malaria"
author: "Sean Finn & Evelyn Lupancu"
date: "Updated `r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
library(readxl)
library(tidyverse)
library(ggcorrplot)
library(grid)
library(gridExtra)
library(cluster)
library(gmodels)
library(ggplot2)
library(MASS)
library(lme4)
library(nlme)
library(mice)
library(gt)
library(paletteer)
theme_set(
  theme_minimal()
)
```

$\hat\pi \pm z_{0.025} * \sqrt{\dfrac{\hat\pi * (1 - \hat\pi)}{n}}$

```{r clean}
malaria <- read_excel("MalariaSampling_MasterFile_Sept23.xlsx")

# Rename long variables
malaria <- malaria %>% rename(screened_l = `Screened for Leuco`,
                              screened_h = `Screened for HAEM`,
                              screened_p = `Screened for Plas`,
                              positive_l = `Positive=1...21`,
                              positive_h = `Positive=1...27`,
                              positive_p = `Positive=1...33`,
                              posdesig_l = `Pos Designation...22`,
                              posdesig_h = `Pos Designation...28`,
                              posdesig_p = `Pos Designation...34`)

# Change elevation, latitude, and longitude variables to numeric
malaria$Elevation <- str_remove_all(malaria$Elevation, "m")
malaria$Elevation <- as.numeric(malaria$Elevation)
malaria$Lat <- as.numeric(malaria$Lat)
malaria$Long <- as.numeric(malaria$Long)

# Impute missing values of Elevation using CARTs
malaria$Elevation[is.na(malaria$Elevation)] <- 
  mice.impute.mean(y = malaria$Elevation, ry = as.vector(!is.na(malaria$Elevation)))

# Standardize sex reporting
malaria$Sex[malaria$Sex == "f"] <- "F"
malaria$Sex[malaria$Sex == "m"] <- "M"
malaria$Sex[malaria$Sex == "?"] <- "X"
malaria$Sex[malaria$Sex == "N"] <- "X"
malaria$Sex[malaria$Sex == "0"] <- "X"
malaria$Sex[malaria$Sex == "No BS"] <- "X"

# Convert negative test results to zeros
malaria <- malaria %>% mutate(positive_l = ifelse(is.na(positive_l), 0, 1),
                              positive_h = ifelse(is.na(positive_h), 0, 1),
                              positive_p = ifelse(is.na(positive_p), 0, 1),
                              posdesig_l = ifelse(is.na(posdesig_l), 0, posdesig_l),
                              posdesig_h = ifelse(is.na(posdesig_h), 0, posdesig_h),
                              posdesig_p = ifelse(is.na(posdesig_p), 0, posdesig_p))

# Shorten Democratic Republic of the Congo (for visualizations)
malaria$Country[malaria$Country=="Democratic Republic Congo"] <- "DRC"

# Create variable for positive result from any genus
malaria$infected_any <- 0
malaria$infected_any[malaria$positive_p == 1 | malaria$positive_l == 1 | malaria$positive_h == 1] <- 1

# Create variables for within and between-genus co-infections
malaria$leuco_coinf <- ifelse(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, 1, 0)
malaria$haemo_coinf <- ifelse(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, 1, 0)
malaria$plas_coinf <- ifelse(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, 1, 0)
malaria$any_coinf_within <- ifelse(malaria$leuco_coinf == 1 | malaria$haemo_coinf == 1 | malaria$plas_coinf == 1,
                            1, 0)
malaria$any_coinf_between <- ifelse((
  (malaria$positive_l == 1 & malaria$positive_h == 1) | 
  (malaria$positive_l == 1 & malaria$positive_p == 1) |
  (malaria$positive_h == 1 & malaria$positive_p == 1)), 1, 0)

# Store numbers related to any malaria infection, co-infection, and screening
infected_all <- sum(malaria$positive_l == 1 | 
                    malaria$positive_h == 1 | 
                    malaria$positive_p == 1, na.rm = T)
coinfected_all <- sum((malaria$positive_l == 1 & malaria$positive_h == 1) | 
    (malaria$positive_l == 1 & malaria$positive_p == 1) |
    (malaria$positive_h == 1 & malaria$positive_p == 1), na.rm = T)
screened_all <- sum(malaria$screened_l=="Yes")

# Find co-infection rates by order
co <- as.data.frame(table(malaria$Host_order, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_order, malaria$any_coinf_between))
coinf_order <- data.frame(Host_order = co$Var1[co$Var2==0],
                          yes.w = as.numeric(co$Freq[co$Var2==1]),
                          no.w = as.numeric(co$Freq[co$Var2==0]),
                          yes.b = as.numeric(cb$Freq[co$Var2==1]),
                          no.b = as.numeric(cb$Freq[co$Var2==0]))
coinf_order$coinf_within_order <- coinf_order$yes.w / (coinf_order$yes.w + coinf_order$no.w)
coinf_order$coinf_between_order <- coinf_order$yes.b / (coinf_order$yes.b + coinf_order$no.b)
coinf_order <- coinf_order[,c("Host_order", "coinf_within_order", "coinf_between_order")]

# Find co-infection rates by family
co <- as.data.frame(table(malaria$Host_family, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_family, malaria$any_coinf_between))
coinf_family <- data.frame(Host_family = co$Var1[co$Var2==0],
                          yes.w = as.numeric(co$Freq[co$Var2==1]),
                          no.w = as.numeric(co$Freq[co$Var2==0]),
                          yes.b = as.numeric(cb$Freq[co$Var2==1]),
                          no.b = as.numeric(cb$Freq[co$Var2==0]))
coinf_family$coinf_within_family <- coinf_family$yes.w / (coinf_family$yes.w + coinf_family$no.w)
coinf_family$coinf_between_family <- coinf_family$yes.b / (coinf_family$yes.b + coinf_family$no.b)
coinf_family <- coinf_family[,c("Host_family", "coinf_within_family", "coinf_between_family")]

# Find co-infection rates by genus
co <- as.data.frame(table(malaria$Host_genus, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_genus, malaria$any_coinf_between))
coinf_genus <- data.frame(Host_genus = co$Var1[co$Var2==0],
                          yes.w = as.numeric(co$Freq[co$Var2==1]),
                          no.w = as.numeric(co$Freq[co$Var2==0]),
                          yes.b = as.numeric(cb$Freq[co$Var2==1]),
                          no.b = as.numeric(cb$Freq[co$Var2==0]))
coinf_genus$coinf_within_genus <- coinf_genus$yes.w / (coinf_genus$yes.w + coinf_genus$no.w)
coinf_genus$coinf_between_genus <- coinf_genus$yes.b / (coinf_genus$yes.b + coinf_genus$no.b)
coinf_genus <- coinf_genus[,c("Host_genus", "coinf_within_genus", "coinf_between_genus")]

# Find co-infection rates by species
co <- as.data.frame(table(malaria$Host_species, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_species, malaria$any_coinf_between))
cLw <- as.data.frame(table(malaria$Host_species, malaria$leuco_coinf))
cPw <- as.data.frame(table(malaria$Host_species, malaria$plas_coinf))
cHw <- as.data.frame(table(malaria$Host_species, malaria$haemo_coinf))
coinf_species <- data.frame(Host_species = co$Var1[co$Var2==0],
                            yes.w = as.numeric(co$Freq[co$Var2==1]),
                            no.w = as.numeric(co$Freq[co$Var2==0]),
                            yes.b = as.numeric(cb$Freq[cb$Var2==1]),
                            no.b = as.numeric(cb$Freq[cb$Var2==0]),
                            yes.Lw = as.numeric(cLw$Freq[cLw$Var2==1]),
                            no.Lw = as.numeric(cLw$Freq[cLw$Var2==0]),
                            yes.Pw = as.numeric(cPw$Freq[cPw$Var2==1]),
                            no.Pw = as.numeric(cPw$Freq[cPw$Var2==0]),
                            yes.Hw = as.numeric(cHw$Freq[cHw$Var2==1]),
                            no.Hw = as.numeric(cHw$Freq[cHw$Var2==0]))
coinf_species$coinf_within_species <- coinf_species$yes.w / (coinf_species$yes.w + coinf_species$no.w)
coinf_species$coinf_between_species <- coinf_species$yes.b / (coinf_species$yes.b + coinf_species$no.b)
coinf_species$coinf_Lwithin_species <- coinf_species$yes.Lw / (coinf_species$yes.Lw + coinf_species$no.Lw)
coinf_species$coinf_Pwithin_species <- coinf_species$yes.Pw / (coinf_species$yes.Pw + coinf_species$no.Pw)
coinf_species$coinf_Hwithin_species <- coinf_species$yes.Hw / (coinf_species$yes.Hw + coinf_species$no.Hw)
coinf_species <- coinf_species[,c("Host_species", "coinf_within_species", 
                                  "coinf_between_species", "coinf_Lwithin_species", 
                                  "coinf_Pwithin_species", "coinf_Hwithin_species")]

# Add co-infection rates to main data frame
malaria <- merge(malaria, coinf_order, by = "Host_order")
malaria <- merge(malaria, coinf_family, by = "Host_family")
malaria <- merge(malaria, coinf_genus, by = "Host_genus")
malaria <- merge(malaria, coinf_species, by = "Host_species")

# Create co-infection rates by species for birds that tested positive for malaria
malaria.posL <- malaria[malaria$positive_l == 1,]
posL.infspecies <- as.data.frame(table(malaria.posL$Host_species, malaria.posL$leuco_coinf))
malaria.posH <- malaria[malaria$positive_h == 1,]
posH.infspecies <- as.data.frame(table(malaria.posH$Host_species, malaria.posH$haemo_coinf))
malaria.posP <- malaria[malaria$positive_p == 1,]
posP.infspecies <- as.data.frame(table(malaria.posP$Host_species, malaria.posP$plas_coinf))
malaria.posB <- malaria[malaria$infected_any == 1,]
posB.infspecies <- as.data.frame(table(malaria.posB$Host_species, malaria.posB$any_coinf_between))

coinfL_species_infected <- data.frame(
  Host_species = posL.infspecies$Var1[posL.infspecies$Var2==0],
  yes.Lw = as.numeric(posL.infspecies$Freq[posL.infspecies$Var2==1]),
  no.Lw = as.numeric(posL.infspecies$Freq[posL.infspecies$Var2==0]))
coinfH_species_infected <- data.frame(
  Host_species = posH.infspecies$Var1[posH.infspecies$Var2==0],
  yes.Hw = as.numeric(posH.infspecies$Freq[posH.infspecies$Var2==1]),
  no.Hw = as.numeric(posH.infspecies$Freq[posH.infspecies$Var2==0]))
coinfP_species_infected <- data.frame(
  Host_species = posP.infspecies$Var1[posP.infspecies$Var2==0],
  yes.Pw = as.numeric(posP.infspecies$Freq[posP.infspecies$Var2==1]),
  no.Pw = as.numeric(posP.infspecies$Freq[posP.infspecies$Var2==0]))
coinfB_species_infected <- data.frame(
  Host_species = posB.infspecies$Var1[posB.infspecies$Var2==0],
  yes.btwn = as.numeric(posB.infspecies$Freq[posB.infspecies$Var2==1]),
  no.btwn = as.numeric(posB.infspecies$Freq[posB.infspecies$Var2==0]))

coinfL_species_infected$coinf_Lwithin_infected <- (coinfL_species_infected$yes.Lw / 
  (coinfL_species_infected$yes.Lw + coinfL_species_infected$no.Lw))
coinfP_species_infected$coinf_Pwithin_infected <- (coinfP_species_infected$yes.Pw / 
  (coinfP_species_infected$yes.Pw + coinfP_species_infected$no.Pw))
coinfH_species_infected$coinf_Hwithin_infected <- (coinfH_species_infected$yes.Hw / 
  (coinfH_species_infected$yes.Hw + coinfH_species_infected$no.Hw))
coinfB_species_infected$coinf_between_infected <- (coinfB_species_infected$yes.btwn / 
  (coinfB_species_infected$yes.btwn + coinfB_species_infected$no.btwn))

coinfL_species_infected <- coinfL_species_infected[, c("Host_species", "coinf_Lwithin_infected")]
coinfH_species_infected <- coinfH_species_infected[, c("Host_species", "coinf_Hwithin_infected")]
coinfP_species_infected <- coinfP_species_infected[, c("Host_species", "coinf_Pwithin_infected")]
coinfB_species_infected <- coinfB_species_infected[, c("Host_species", "coinf_between_infected")]

# Add co-infection rates among infected birds to main data frame  
malaria <- merge(malaria, coinfL_species_infected, by = "Host_species", all.x = T)
malaria <- merge(malaria, coinfH_species_infected, by = "Host_species", all.x = T)
malaria <- merge(malaria, coinfP_species_infected, by = "Host_species", all.x = T)
malaria <- merge(malaria, coinfB_species_infected, by = "Host_species", all.x = T)

# Convert number of groups by taxonomic level to data frames
order_freqs <- as.data.frame(table(malaria$Host_order))
family_freqs <- as.data.frame(table(malaria$Host_family))
genus_freqs <- as.data.frame(table(malaria$Host_genus))
species_freqs <- as.data.frame(table(malaria$Host_species))

# Create reduced version of data frames with counts that create minimum expected values in chi-squared tests
order_reduced_within <- order_freqs[order_freqs$Freq >= 25,]
family_reduced_within <- family_freqs[family_freqs$Freq >= 40,]
genus_reduced_within <- genus_freqs[genus_freqs$Freq >= 40,]
species_reduced_within <- species_freqs[species_freqs$Freq >= 60,]

order_reduced_between <- order_freqs[order_freqs$Freq >= 50,]
family_reduced_between <- family_freqs[family_freqs$Freq >= 55,]
genus_reduced_between <- genus_freqs[genus_freqs$Freq >= 55,]
species_reduced_between <- species_freqs[species_freqs$Freq >= 75,]

# Prepare data for chi-squared test tables
Xdata_order_within <- malaria[malaria$Host_order %in% order_reduced_within$Var1,]
Xdata_family_within <- malaria[malaria$Host_family %in% family_reduced_within$Var1,]
Xdata_genus_within <- malaria[malaria$Host_genus %in% genus_reduced_within$Var1,]
Xdata_species_within <- malaria[malaria$Host_species %in% species_reduced_within$Var1,]

Xdata_order_between <- malaria[malaria$Host_order %in% order_reduced_between$Var1,]
Xdata_family_between <- malaria[malaria$Host_family %in% family_reduced_between$Var1,]
Xdata_genus_between <- malaria[malaria$Host_genus %in% genus_reduced_between$Var1,]
Xdata_species_between <- malaria[malaria$Host_species %in% species_reduced_between$Var1,]

# Change reference groups to mode for each taxonomic level (for regression)
Xdata_order_within$Host_order <- relevel(as.factor(Xdata_order_within$Host_order), "Passeriformes")
Xdata_family_within$Host_family <- relevel(as.factor(Xdata_family_within$Host_family), "Pycnonotidae")
Xdata_genus_within$Host_genus <- relevel(as.factor(Xdata_genus_within$Host_genus), "Calandrella")
Xdata_species_within$Host_species <- relevel(as.factor(Xdata_species_within$Host_species), "cinerea")
Xdata_order_between$Host_order <- relevel(as.factor(Xdata_order_between$Host_order), "Passeriformes")
Xdata_family_between$Host_family <- relevel(as.factor(Xdata_family_between$Host_family), "Pycnonotidae")
Xdata_genus_between$Host_genus <- relevel(as.factor(Xdata_genus_between$Host_genus), "Calandrella")
Xdata_species_between$Host_species <- relevel(as.factor(Xdata_species_between$Host_species), "cinerea")

# Change reference groups to mode (Kenya) for country
Xdata_order_within$Country <- relevel(as.factor(Xdata_order_within$Country), "Kenya")
Xdata_family_within$Country <- relevel(as.factor(Xdata_family_within$Country), "Kenya")
Xdata_genus_within$Country <- relevel(as.factor(Xdata_genus_within$Country), "Kenya")
Xdata_species_within$Country <- relevel(as.factor(Xdata_species_within$Country), "Kenya")
Xdata_order_between$Country <- relevel(as.factor(Xdata_order_between$Country), "Kenya")
Xdata_family_between$Country <- relevel(as.factor(Xdata_family_between$Country), "Kenya")
Xdata_genus_between$Country <- relevel(as.factor(Xdata_genus_between$Country), "Kenya")
Xdata_species_between$Country <- relevel(as.factor(Xdata_species_between$Country), "Kenya")

# Change taxonomic variables to factors
malaria <- malaria %>% mutate(Host_order = as.factor(malaria$Host_order),
                              Host_family = as.factor(malaria$Host_family),
                              Host_genus = as.factor(malaria$Host_genus),
                              Host_species = as.factor(malaria$Host_species), 
                              Host_subspp = as.factor(malaria$Host_subspp))
```

## Exploratory Data Analysis

```{r}
country.table <- as.data.frame(table(malaria$Country))
country.table <- data.frame(Country = country.table$Var1, Count = country.table$Freq)
country.tab <- country.table %>% gt(rowname_col = "Country") %>% 
  tab_stubhead(label = md("**Country**")) %>%
  tab_header(title = md("**Number of Avian Samples by Country**")) %>%
  fmt_number(columns = Count, decimals = 0) %>%
  cols_align(columns = Count, align = "center") %>%
  cols_label(Count = md("**Count**")) %>%
  cols_width(Country ~ px(160),
             Count ~ px(100)) %>%
  grand_summary_rows(fns = list("Total" = ~sum(.)),
               formatter = fmt_number, decimals = 0) %>%
  tab_style(cell_text(align = "left"), cells_stub_grand_summary())
country.tab

gtsave(country.tab, "avian sample count by country.png")
```

```{r}
elevation <- ggplot(malaria, aes(Elevation)) +
  geom_histogram(bins = 15, fill = "chartreuse3", color = "chartreuse4") +
  labs(title = "Elevation of Avian Samples",
       x = "\nElevation of sample collection (ft)", y = "Number of samples \n") +
  scale_x_continuous(limits = c(0, 3000))
elevation

ggsave("elevation hist.png", elevation, width = 6, height = 4)

```

#### Infections by country
```{r}
leuco.country <- as.data.frame(table(malaria$positive_l, malaria$Country))
leuco_eda1 <- ggplot(leuco.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer() +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

leuco_eda2 <- ggplot(leuco.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(name = "Test result", labels = c("Not positive", "Positive")) +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

leuco_eda <- grid.arrange(leuco_eda1, leuco_eda2, nrow = 1, 
             top = "Leucocytozoon Prevalence by Country")
ggsave("leucocytozoon by country.png", leuco_eda, width = 7, height = 4)
```

```{r}
haemo.country <- as.data.frame(table(malaria$positive_h, malaria$Country))
haemo_eda1 <- ggplot(haemo.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 4) +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

haemo_eda2 <- ggplot(haemo.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 4, name = "Test result", 
                    labels = c("Not positive", "Positive")) +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

haemo_eda <- grid.arrange(haemo_eda1, haemo_eda2, nrow = 1, 
             top = "Haemoproteus Prevalence by Country")
ggsave("haemoproteus by country.png", haemo_eda, width = 7, height = 4)
```

```{r}
plas.country <- as.data.frame(table(malaria$positive_p, malaria$Country))  
plas_eda1 <- ggplot(plas.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 7) +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

plas_eda2 <- ggplot(plas.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 7, name = "Test result", 
                    labels = c("Not positive", "Positive")) +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

plas_eda <- grid.arrange(plas_eda1, plas_eda2, nrow = 1, 
             top = "Plasmodium Prevalence by Country")
ggsave("plasmodium by country.png", plas_eda, width = 7, height = 4)
```

#### Significance testing by country

```{r}
summary(glm(positive_l ~ Country, data = malaria, family = binomial))
summary(glm(positive_h ~ Country, data = malaria, family = binomial))
summary(glm(positive_p ~ Country, data = malaria, family = binomial))
summary(glm(infected_any ~ Country, data = malaria, family = binomial))
```


#### Infections by sex  
```{r}
leuco.sex <- as.data.frame(table(malaria$positive_l[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
leuco_eda3 <- ggplot(leuco.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer() +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9),
        aspect.ratio = 1.4)

leuco_eda4 <- ggplot(leuco.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(name = "Test result", labels = c("Not positive", "Positive")) +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

leuco_eda_sex <- grid.arrange(leuco_eda3, leuco_eda4, nrow = 1, widths = c(1,1),
                  top = "Leucocytozoon Prevalence by Sex")

ggsave("leucocytozoon by sex.png", leuco_eda_sex, width = 6, height = 3)
```

```{r}
haemo.sex <- as.data.frame(table(malaria$positive_h[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
haemo_eda3 <- ggplot(haemo.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 4) +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

haemo_eda4 <- ggplot(haemo.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 4, name = "Test result", 
                    labels = c("Not positive", "Positive")) +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

haemo_eda_sex <- grid.arrange(haemo_eda3, haemo_eda4, nrow = 1, widths = c(1,1),
             top = "Haemoproteus Prevalence by Sex")
ggsave("haemocrodius by sex.png", haemo_eda_sex, width = 6, height = 3)
```

```{r}
plas.sex <- as.data.frame(table(malaria$positive_p[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
plas_eda3 <- ggplot(plas.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 7) +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

plas_eda4 <- ggplot(plas.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 7, name = "Test result", 
                    labels = c("Not positive", "Positive")) +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

plas_eda_sex <- grid.arrange(plas_eda3, plas_eda4, nrow = 1, widths = c(1,1),
             top = "Plasmodium Prevalence by Sex")
ggsave("plasmodium by sex.png", plas_eda_sex, width = 6, height = 3)
```

#### Significance testing by sex

```{r}
summary(glm(positive_l ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
summary(glm(positive_h ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
summary(glm(positive_p ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
summary(glm(infected_any ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
```


## 1. How often do co-infections occur within the same genus of avian malarial pathogen? 

NOTE: Create survey weights -- weight based on each taxonomic level
      can also weight by country, or sampling areas

Compare with using the negative binomial distribution for confidence intervals

#### *Among birds who are infected*
```{r}
total_n <- 3418

# Leucocytozoon
n_L <- sum(malaria$positive_l, na.rm = T) # How many positive 
p_L <- sum(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, na.rm = T) / n_L
w.p.L <- mean(coinfL_species_infected$coinf_Lwithin_infected, na.rm = T)
cat("Unweighted p-hat for Leuco:", round(p_L, 4), "\n")
cat("Weighted p-hat for Leuco:", round(w.p.L, 4), "\n")

ci_L.lower <- p_L - qnorm(0.975) * sqrt((p_L * (1 - p_L)) / n_L)
ci_L.upper <- p_L + qnorm(0.975) * sqrt((p_L * (1 - p_L)) / n_L)
cat("Leucocytozoon unweighted 95% CI: [", round(c(ci_L.lower, ci_L.upper)*100, 2), "]", "\n")
wci_L.lower <- w.p.L - qnorm(0.975) * sqrt((w.p.L * (1 - w.p.L)) / n_L)
wci_L.upper <- w.p.L + qnorm(0.975) * sqrt((w.p.L * (1 - w.p.L)) / n_L)
cat("Leucocytozoon weighted 95% CI: [", round(c(wci_L.lower, wci_L.upper)*100, 2), "]", "\n", "\n")

# Haemoproteus
n_H <- sum(malaria$positive_h, na.rm = T) # How many positive 
p_H <- sum(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, na.rm = T) / n_H
w.p.H <- mean(coinfH_species_infected$coinf_Hwithin_infected, na.rm = T)
cat("Unweighted p-hat for Haemo:", round(p_H, 4), "\n")
cat("Weighted p-hat for Haemo:", round(w.p.H, 4), "\n")

ci_H.lower <- p_H - qnorm(0.975) * sqrt((p_H * (1 - p_H)) / n_H)
ci_H.upper <- p_H + qnorm(0.975) * sqrt((p_H * (1 - p_H)) / n_H)
cat("Haemoproteus unweighted 95% CI: [", round(c(ci_H.lower, ci_H.upper)*100, 2), "]", "\n")
wci_H.lower <- w.p.H - qnorm(0.975) * sqrt((w.p.H * (1 - w.p.H)) / n_H)
wci_H.upper <- w.p.H + qnorm(0.975) * sqrt((w.p.H * (1 - w.p.H)) / n_H)
cat("Haemoproteus weighted 95% CI: [", round(c(wci_H.lower, wci_H.upper)*100, 2), "]", "\n", "\n")

# Plasmodium
n_P <- sum(malaria$positive_p, na.rm = T) # How many positive 
p_P <- sum(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, na.rm = T) / n_P
w.p.P <- mean(coinfP_species_infected$coinf_Pwithin_infected, na.rm = T)
cat("Unweighted p-hat for Plasmodium:", round(p_P, 4), "\n")
cat("Weighted p-hat for Plasmodium:", round(w.p.P, 4), "\n")

ci_P.lower <- p_P - qnorm(0.975) * sqrt((p_P * (1 - p_P)) / n_P)
ci_P.upper <- p_P + qnorm(0.975) * sqrt((p_P * (1 - p_P)) / n_P)
cat("Plasmodium unweighted 95% CI: [", round(c(ci_P.lower, ci_P.upper)*100, 2), "]", "\n")
wci_P.lower <- w.p.P - qnorm(0.975) * sqrt((w.p.P * (1 - w.p.P)) / n_P)
wci_P.upper <- w.p.P + qnorm(0.975) * sqrt((w.p.P * (1 - w.p.P)) / n_P)
cat("Plasmodium weighted 95% CI: [", round(c(wci_P.lower, wci_P.upper)*100, 2), "]", "\n", "\n")

```

```{r}
genera <- c("Leucocytozoon", "Haemoproteus", "Plasmodium")
y <- c(p_L*100, p_H*100, p_P*100)
ymin <- c(ci_L.lower*100, ci_H.lower*100, ci_P.lower*100)
ymax <- c(ci_L.upper*100, ci_H.upper*100, ci_P.upper*100)
wald_boxes <- as.data.frame(cbind(genera, y, ymin, ymax))
wald_boxes <- wald_boxes %>% mutate(y = as.numeric(y),
                                    ymin = as.numeric(ymin),
                                    ymax = as.numeric(ymax))

wald_boxes_chart <- ggplot(wald_boxes, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 30)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Prevalence of Malaria Infection by Genus (Unweighted)", 
       subtitle = "Among birds infected with each genus",
       x = "\n Genus", y = "Percent of birds infected\n")
wald_boxes_chart

ggsave("frequency by genus1.png", wald_boxes_chart, height = 4, width = 6)
```


```{r}
genera <- c("Leucocytozoon", "Haemoproteus", "Plasmodium")
y <- c(w.p.L*100, w.p.H*100, w.p.P*100)
ymin <- c(wci_L.lower*100, wci_H.lower*100, wci_P.lower*100)
ymax <- c(wci_L.upper*100, wci_H.upper*100, wci_P.upper*100)
wald_boxes.w <- as.data.frame(cbind(genera, y, ymin, ymax))
wald_boxes.w <- wald_boxes.w %>% mutate(y = as.numeric(y),
                                    ymin = as.numeric(ymin),
                                    ymax = as.numeric(ymax))

wald_boxes_chart.w <- ggplot(wald_boxes.w, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 30)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Prevalence of Malaria Infection by Genus (Weighted)", 
       subtitle = "Among birds infected with each genus",
       x = "\n Genus", y = "Percent of birds infected\n")
wald_boxes_chart.w

ggsave("frequency by genus1 weighted.png", wald_boxes_chart.w, height = 4, width = 6)
```

#### *Among all birds screened*

```{r}
total_n <- 3418

# Leucocytozoon
num_screened_l <- sum(malaria$screened_l == "Yes") 
p2_L <- sum(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, na.rm = T) / num_screened_l
w.phat.L <- mean(coinf_species$coinf_Lwithin_species)
cat("Unweighted p-hat for Leuco:", round(p2_L, 4), "\n")
cat("Weighted p-hat for Leuco:", round(w.phat.L, 4), "\n")

ci2_L.lower <- p2_L - qnorm(0.975) * sqrt((p2_L * (1 - p2_L)) / num_screened_l)
ci2_L.upper <- p2_L + qnorm(0.975) * sqrt((p2_L * (1 - p2_L)) / num_screened_l)
cat("Leucocytozoon unweighted 95% CI: [", round(c(ci2_L.lower, ci2_L.upper)*100, 2), "]", "\n")
wci2_L.lower <- w.phat.L - qnorm(0.975) * sqrt((w.phat.L * (1 - w.phat.L)) / num_screened_l)
wci2_L.upper <- w.phat.L + qnorm(0.975) * sqrt((w.phat.L * (1 - w.phat.L)) / num_screened_l)
cat("Leucocytozoon weighted 95% CI: [", round(c(wci2_L.lower, wci2_L.upper)*100, 2), "]", "\n", "\n")

# Haemoproteus
w.phat.H <- mean(coinf_species$coinf_Hwithin_species)
p2_H <- sum(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, na.rm = T) / total_n
cat("Unweighted p-hat for Haemo:", round(p2_H, 4), "\n")
cat("Weighted p-hat for Haemo:", round(w.phat.H, 4), "\n")

ci2_H.lower <- p2_H - qnorm(0.975) * sqrt((p2_H * (1 - p2_H)) / total_n)
ci2_H.upper <- p2_H + qnorm(0.975) * sqrt((p2_H * (1 - p2_H)) / total_n)
cat("Haemoproteus unweighted 95% CI: [", round(c(ci2_H.lower, ci2_H.upper)*100, 2), "]", "\n")
wci2_H.lower <- w.phat.H - qnorm(0.975) * sqrt((w.phat.H * (1 - w.phat.H)) / total_n)
wci2_H.upper <- w.phat.H + qnorm(0.975) * sqrt((w.phat.H * (1 - w.phat.H)) / total_n)
cat("Haemoproteus weighted 95% CI: [", round(c(wci2_H.lower, wci2_H.upper)*100, 2), "]", "\n", "\n")

# Plasmodium
p2_P <- sum(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, na.rm = T) / total_n
w.phat.P <- mean(coinf_species$coinf_Pwithin_species)
cat("Unweighted p-hat for Plasmodium:", round(p2_P, 4), "\n")
cat("Weighted p-hat for Plasmodium:", round(w.phat.P, 4), "\n")

ci2_P.lower <- p2_P - qnorm(0.975) * sqrt((p2_P * (1 - p2_P)) / total_n)
ci2_P.upper <- p2_P + qnorm(0.975) * sqrt((p2_P * (1 - p2_P)) / total_n)
cat("Plasmodium unweighted 95% CI: [", round(c(ci2_P.lower, ci2_P.upper)*100, 2), "]", "\n")

wci2_P.lower <- w.phat.P - qnorm(0.975) * sqrt((w.phat.P * (1 - w.phat.P)) / total_n)
wci2_P.upper <- w.phat.P + qnorm(0.975) * sqrt((w.phat.P * (1 - w.phat.P)) / total_n)
cat("Plasmodium weighted 95% CI: [", round(c(wci2_P.lower, wci2_P.upper)*100, 2), "]", "\n", "\n")

```


```{r}
genera <- c("Leucocytozoon", "Haemoproteus", "Plasmodium")
y2 <- c(p2_L*100, p2_H*100, p2_P*100)
ymin2 <- c(ci2_L.lower*100, ci2_H.lower*100, ci2_P.lower*100)
ymax2 <- c(ci2_L.upper*100, ci2_H.upper*100, ci2_P.upper*100)
wald_boxes2 <- as.data.frame(cbind(genera, y2, ymin2, ymax2))
wald_boxes2 <- wald_boxes %>% mutate(y = as.numeric(y2),
                                    ymin = as.numeric(ymin2),
                                    ymax = as.numeric(ymax2))

wald_boxes_chart2 <- ggplot(wald_boxes2, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 8)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Prevalence of Malaria Infection by Genus (Unweighted)", 
       subtitle = "Among all birds screened for each genus", 
       x = "\n Genus", y = "Percent of birds infected\n")
wald_boxes_chart2

ggsave("frequency by genus2.png", wald_boxes_chart2, height = 4, width = 6)
```

```{r}
genera <- c("Leucocytozoon", "Haemoproteus", "Plasmodium")
y3 <- c(w.phat.L*100, w.phat.H*100, w.phat.P*100)
ymin3 <- c(wci2_L.lower*100, wci2_H.lower*100, wci2_P.lower*100)
ymax3 <- c(wci2_L.upper*100, wci2_H.upper*100, wci2_P.upper*100)
wald_boxes3 <- as.data.frame(cbind(genera, y3, ymin3, ymax3))
wald_boxes3 <- wald_boxes %>% mutate(y = as.numeric(y3),
                                     ymin = as.numeric(ymin3),
                                     ymax = as.numeric(ymax3))

wald_boxes_chart3 <- ggplot(wald_boxes3, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 8)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Prevalence of Malaria Infection by Genus (Weighted)", 
       subtitle = "Among all birds screened for each genus", 
       x = "\n Genus", y = "Percent of birds infected\n")
wald_boxes_chart3

ggsave("frequency by genus3.png", wald_boxes_chart3, height = 4, width = 6)
```

## 2. How often do co-infections occur between different genera of avian malarial pathogens?

#### *Among birds that tested positive for malaria*

```{r}
infected_all <- sum(malaria$positive_l == 1 | 
                    malaria$positive_h == 1 | 
                    malaria$positive_p == 1, na.rm = T)
coinfected_all <- sum((malaria$positive_l == 1 & malaria$positive_h == 1) | 
    (malaria$positive_l == 1 & malaria$positive_p == 1) |
    (malaria$positive_h == 1 & malaria$positive_p == 1), na.rm = T)
p3 <- coinfected_all / infected_all
wp3 <- mean(coinfB_species_infected$coinf_between_infected, na.rm = T)
cat("Unweighted p-hat:", round(p3, 4), "\n")
cat("Weighted p-hat:", round(wp3, 4), "\n")

ci3.lower <- p3 - qnorm(0.975) * sqrt((p3 * (1 - p3)) / infected_all)
ci3.upper <- p3 + qnorm(0.975) * sqrt((p3 * (1 - p3)) / infected_all)
cat("Unweighted 95% confidence interval: [", round(c(ci3.lower, ci3.upper)*100, 2), "] \n")
wci3.lower <- wp3 - qnorm(0.975) * sqrt((wp3 * (1 - wp3)) / infected_all)
wci3.upper <- wp3 + qnorm(0.975) * sqrt((wp3 * (1 - wp3)) / infected_all)
cat("Weighted 95% confidence interval: [", round(c(wci3.lower, wci3.upper)*100, 2), "] \n")

```

#### *Among all birds screened*

```{r}
screened_all <- sum(malaria$screened_l=="Yes") # Leuco is only genus that didn't get tested for all birds
p4 <- coinfected_all / screened_all
wp4 <- mean(coinf_species$coinf_between_species, na.rm = T)
cat("Unweighted p-hat:", round(p4, 4), "\n")
cat("Weighted p-hat:", round(wp4, 4), "\n")

ci4.lower <- p4 - qnorm(0.975) * sqrt((p4 * (1 - p4)) / screened_all)
ci4.upper <- p4 + qnorm(0.975) * sqrt((p4 * (1 - p4)) / screened_all)
cat("95% confidence interval: [", round(c(ci4.lower, ci4.upper)*100, 2), "] \n")
wci4.lower <- wp4 - qnorm(0.975) * sqrt((wp4 * (1 - wp4)) / screened_all)
wci4.upper <- wp4 + qnorm(0.975) * sqrt((wp4 * (1 - wp4)) / screened_all)
cat("Weighted 95% confidence interval: [", round(c(wci4.lower, wci4.upper)*100, 2), "] \n")

```

## 3. Are certain host birds more susceptible to co-infections than other hosts?

Start by looking into: Species, genus, family level
Remove groups that have less than 3 individuals, 5 individuals, 10 individuals - see what results look like
Pseudo-count (for many zeros in data) - look into this
Zero-inflated distributions, try other distributions

OUTCOME VARIABLE: Co-infection present (binary)
MODEL IDEAS:
- multivariate logistic regression
  + main effect variable: species/genus/family (categorical)
  + would need to remove groups with low counts, not enough confidence

OUTCOME VARIABLE: Co-infection rate by species/genus/family
MODEL IDEAS:
- Clustering
- Prediction of co-infection with random forest using family co-infection rate as predictor
- Zero-inflated Beta regression

NESTED MODELS

CLUSTERING:
* k-means clustering

```{r taxonomy.tables}
# Number of unique taxonomic groups by level
length(unique(malaria$Host_order))
length(unique(malaria$Host_family))
length(unique(malaria$Host_genus))
length(unique(malaria$Host_species))
length(unique(malaria$Host_subspp)) # ignore this

# Tables of taxonomic groups by frequency
malaria %>% group_by(Host_order) %>% summarize(Count = n()) %>% arrange(desc(Count))
malaria %>% group_by(Host_family) %>% summarize(Count = n()) %>% arrange(desc(Count))
malaria %>% group_by(Host_genus) %>% summarize(Count = n()) %>% arrange(desc(Count))
malaria %>% group_by(Host_species) %>% summarize(Count = n()) %>% arrange(desc(Count))

# Look at tables for chi-squared tests - within-genus co-infection
table(Xdata_order_within$Host_order, Xdata_order_within$any_coinf_within)
table(Xdata_family_within$Host_family, Xdata_family_within$any_coinf_within)
table(Xdata_genus_within$Host_genus, Xdata_genus_within$any_coinf_within)
table(Xdata_species_within$Host_species, Xdata_species_within$any_coinf_within)

# Look at tables for chi-squared tests - between-genus co-infection
table(Xdata_order_between$Host_order, Xdata_order_between$any_coinf_between)
table(Xdata_family_between$Host_family, Xdata_family_between$any_coinf_between)
table(Xdata_genus_between$Host_genus, Xdata_genus_between$any_coinf_between)
table(Xdata_species_between$Host_species, Xdata_species_between$any_coinf_between)

```

```{r taxa.hists}
order_hist <- ggplot(order_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#98cd59") +
              labs(x = "Order", y = NULL) +
              theme(axis.title.y = element_text(size = 12))
family_hist <- ggplot(family_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#2ebd63") +
              labs(x = "Family", y = NULL) +
              scale_x_continuous(limits = c(0,450)) +
              scale_y_continuous(limits = c(0,11)) +
              theme(axis.title.y = element_text(size = 12))
genus_hist <- ggplot(genus_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#10b7e5") +
              labs(x = "Genus", y = NULL) +
              scale_x_continuous(limits = c(0,450)) +
              scale_y_continuous(limits = c(0,45)) +
              theme(axis.title.y = element_text(size = 12))
species_hist <- ggplot(species_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#0f8ac7") +
              labs(x = "Species", y = NULL) +
              scale_x_continuous(limits = c(0,450)) +
              scale_y_continuous(limits = c(0,70)) +
              theme(axis.title.y = element_text(size = 12))

tax_freq_hists <- grid.arrange(order_hist, family_hist, genus_hist, species_hist,
                               ncol = 1)
ggsave("taxonomical frequencies.png", tax_freq_hists, height = 4, width = 3)
```

### LOESS smoothing

```{r loess.year}
## Order #######################################################################
malaria.red <- malaria[, c('Host_order', 'Host_family', 'Host_genus', 
                           'Host_species', 'Year', 'coinf_within_order',
                           'coinf_within_family', 'coinf_within_genus',
                           'coinf_within_species', 'coinf_between_order', 
                           'coinf_between_family', 'coinf_between_genus', 
                           'coinf_between_species', 'Elevation')]
malaria.red <- malaria.red[!is.na(malaria.red$Year),]
malaria.red <- malaria.red[malaria.red$Year != 2014,]
order.loess.w <- ggplot(malaria.red, aes(Year, coinf_within_order)) +
  geom_jitter(aes(color = as.factor(Year)), pch = 1, width = 0.4, height = 0.015,
              show.legend = FALSE) + 
  geom_smooth(method = "loess", color = "black", fill = "yellow", size = 0.7) +
  scale_color_brewer(palette = "Set1") + 
  labs(title = "Avian Orders' Within-Genus Coinfection Rates by Year \nwith LOESS Smoothing Curve",
       x = "\nYear", y = "Coinfection\nrate") +
  theme(axis.title.y = element_text(angle = 0, vjust = 0.5))
order.loess.w

ggsave("LOESS order within.png", order.loess.w)

order.loess.b <- ggplot(malaria.red, aes(Year, coinf_between_order)) +
  geom_jitter(aes(color = as.factor(Year)), pch = 1, width = 0.4, height = 0.015,
              show.legend = FALSE) + 
  geom_smooth(method = "loess", color = "black", fill = "yellow", size = 0.7) +
  scale_color_brewer(palette = "Set1") + 
  labs(title = "Avian Orders' Between-Genus Coinfection Rates by Year \nwith LOESS Smoothing Curve",
       x = "\nYear", y = "Coinfection\nrate") +
  theme(axis.title.y = element_text(angle = 0, vjust = 0.5))
order.loess.b

ggsave("LOESS order between.png", order.loess.b)

## Species ######################################################################
species.loess.w <- ggplot(malaria.red, aes(Year, coinf_within_species)) +
  geom_jitter(aes(color = as.factor(Year)), pch = 1, width = 0.4, height = 0.015,
              show.legend = FALSE) + 
  geom_smooth(method = "loess", color = "black", fill = "yellow", size = 0.7) +
  scale_color_brewer(palette = "Set1") + 
  labs(title = "Avian Species' Within-Genus Coinfection Rates by Year \nwith LOESS Smoothing Curve",
       x = "\nYear", y = "Coinfection\nrate") +
  theme(axis.title.y = element_text(angle = 0, vjust = 0.5))
species.loess.w

ggsave("LOESS species within.png", species.loess.w)

species.loess.b <- ggplot(malaria.red, aes(Year, coinf_between_species)) +
  geom_jitter(aes(color = as.factor(Year)), pch = 1, width = 0.4, height = 0.015,
              show.legend = FALSE) + 
  geom_smooth(method = "loess", color = "black", fill = "yellow", size = 0.7) +
  scale_color_brewer(palette = "Set1") + 
  labs(title = "Avian Species' Between-Genus Coinfection Rates by Year \nwith LOESS Smoothing Curve",
       x = "\nYear", y = "Coinfection\nrate") +
  theme(axis.title.y = element_text(angle = 0, vjust = 0.5))
species.loess.b

ggsave("LOESS species between.png", species.loess.b)

```

#### Chi-squared tests for independence
```{r chisquared.tests}
# Chi-squared tests - within-genus co-infection
(Xwithin.order <-   chisq.test(table(Xdata_order_within$Host_order, 
                                     Xdata_order_within$any_coinf_within)))
Xwithin.order$stdres

(Xwithin.family <-  chisq.test(table(Xdata_family_within$Host_family, 
                                     Xdata_family_within$any_coinf_within)))
Xwithin.family$stdres

(Xwithin.genus <-   chisq.test(table(Xdata_genus_within$Host_genus, 
                                     Xdata_genus_within$any_coinf_within)))
Xwithin.genus$stdres

(Xwithin.species <- chisq.test(table(Xdata_species_within$Host_species, 
                                     Xdata_species_within$any_coinf_within)))
Xwithin.species$stdres

# Chi-squared tests - between-genus co-infection
(Xbetween.order <-   chisq.test(table(Xdata_order_between$Host_order, 
                                      Xdata_order_between$any_coinf_between)))
Xbetween.order$stdres

(Xbetween.family <-  chisq.test(table(Xdata_family_between$Host_family, 
                                      Xdata_family_between$any_coinf_between)))
Xbetween.family$stdres

(Xbetween.genus <-   chisq.test(table(Xdata_genus_between$Host_genus, 
                                      Xdata_genus_between$any_coinf_between)))
Xbetween.genus$stdres

(Xbetween.species <- chisq.test(table(Xdata_species_between$Host_species, 
                                      Xdata_species_between$any_coinf_between)))
```

#### Tables for chi-squared tests

```{r chisquare.overall}
summary.x2 <- data.frame(
  wchi2 = c(Xwithin.order$statistic, Xwithin.family$statistic,
            Xwithin.genus$statistic, Xwithin.species$statistic),
  wdf = c(Xwithin.order$parameter, Xwithin.family$parameter,
            Xwithin.genus$parameter, Xwithin.species$parameter),
  wpval = c(Xwithin.order$p.value, Xwithin.family$p.value,
            Xwithin.genus$p.value, Xwithin.species$p.value),
  bchi2 = c(Xbetween.order$statistic, Xbetween.family$statistic,
            Xbetween.genus$statistic, NA),
  bdf = c(Xbetween.order$parameter, Xbetween.family$parameter,
            Xbetween.genus$parameter, NA),
  bpval = c(Xbetween.order$p.value, Xbetween.family$p.value,
            Xbetween.genus$p.value, NA),
  host.bird = c("Order", "Family", "Genus", "Species"))

summary.x2.table <- summary.x2 %>% 
  gt(rowname_col = "host.bird") %>% 
  tab_stubhead(label = md("**Host Bird Taxonomic Group**")) %>%
  tab_header(title = md("**Summary of Chi-Squared Test Results for Within- and Between-Genus Co-Infections by Reduced Taxonomic Group**")) %>%
  fmt_number(columns = c(wchi2, bchi2), decimals = 2) %>%
  fmt_number(columns = c(wdf, bdf), decimals = 0) %>%
  fmt_number(columns = c(wpval, bpval), decimals = 3) %>%
  cols_align(columns = c(wchi2, bchi2, wdf, bdf, wpval, bpval), 
             align = "center") %>%
  tab_spanner(label = md("**Within-Genus Co-Infection**"),
              columns = c(wchi2, wdf, wpval)) %>%
  tab_spanner(label = md("**Between-Genus Co-Infection**"),
              columns = c(bchi2, bdf, bpval)) %>%
  cols_label(wchi2 = md("*Test statistic*"),
             bchi2 = md("*Test statistic*"),
             wdf = md("*df*"), 
             bdf = md("*df*"), 
             wpval = md("*p-value*"),
             bpval = md("*p-value*"),) %>%
  cols_width(wchi2 ~ px(100),
             bchi2 ~ px(100),
             wdf ~ px(80),
             bdf ~ px(80),
             wpval ~ px(90),
             bpval ~ px(90),
             host.bird ~ px(150)) %>%
  data_color(columns = c(wpval, bpval),
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
summary.x2.table

gtsave(summary.x2.table, "Chi-Squared Summary Table.png")
```

```{r chisquared.table1}
X2.table.order.w <- data.frame(Order = attr(Xwithin.order$stdres, "dimnames")[[1]],
                            Observed = Xwithin.order$observed[,1], 
                            Expected = Xwithin.order$expected[,1], 
                            Difference = (Xwithin.order$observed[,1] - Xwithin.order$expected[,1]), 
                            Std.Res = Xwithin.order$stdres[,1])
table.order.w <- X2.table.order.w %>% gt(rowname_col = "Order") %>% 
  tab_stubhead(label = md("**Order**")) %>%
  tab_header(title = md("**Chi-Squared Test Results for Within-Genus Coinfection by Avian Order**")) %>%
  fmt_number(columns = c(Observed, Expected, Difference, Std.Res), decimals = 2) %>%
  cols_align(columns = c(Observed, Expected, Difference, Std.Res), align = "center") %>%
  cols_label(Observed = md("*Observed counts*"),
             Expected = md("*Expected counts*"),
             Difference = md("*Difference*"),
             Std.Res = md("*Standard residuals*")) %>%
  cols_width(Observed ~ px(100),
             Expected ~ px(100),
             Difference ~ px(100),
             Std.Res ~ px(100),
             Order ~ px(180)) %>%
  data_color(columns = Std.Res,
             colors = scales::col_numeric(
               palette = c("red", "orange", "yellow", "green", "yellow", "orange", "red"),
               domain = c(-8, 8)))

gtsave(table.order.w, "Chi-squared within-genus order.png")
```

#### Logistic regression: All orders, families, genera
```{r basic.logreg}
# Any within-genus co-infection
w.glm1 <- glm(any_coinf_within ~ Host_order, data = malaria, family = binomial)
summary(w.glm1)

w.glm2 <- glm(any_coinf_within ~ Host_family, data = malaria, family = binomial)
summary(w.glm2)

w.glm3 <- glm(any_coinf_within ~ Host_genus, data = malaria, family = binomial)
summary(w.glm3)

w.glm4 <- glm(any_coinf_within ~ Host_species, data = malaria, family = binomial)
summary(w.glm4)

# Any between-genera co-infection
b.glm1 <- glm(any_coinf_between ~ Host_order, data = malaria, family = binomial)
summary(b.glm1)

b.glm2 <- glm(any_coinf_between ~ Host_family, data = malaria, family = binomial)
summary(b.glm2)

b.glm3 <- glm(any_coinf_between ~ Host_genus, data = malaria, family = binomial)
summary(b.glm3)

b.glm4 <- glm(any_coinf_between ~ Host_species, data = malaria, family = binomial)
summary(b.glm4)
```

#### Logistic regression: Reduced orders, families, genera, species
```{r reduced.logreg}
# Any within-genus co-infection
rw.glm1 <- glm(any_coinf_within ~ Host_order, data = Xdata_order_within, family = binomial)
summary(rw.glm1)

rw.glm2 <- glm(any_coinf_within ~ Host_family, data = Xdata_family_within, family = binomial)
summary(rw.glm2)

rw.glm3 <- glm(any_coinf_within ~ Host_genus, data = Xdata_genus_within, family = binomial)
summary(rw.glm3)

rw.glm4 <- glm(any_coinf_within ~ Host_species, data = Xdata_species_within, family = binomial)
summary(rw.glm4)

# Any between-genera co-infection
rb.glm1 <- glm(any_coinf_between ~ Host_order, data = Xdata_order_between, family = binomial)
summary(rb.glm1)

rb.glm2 <- glm(any_coinf_between ~ Host_family, data = Xdata_family_between, family = binomial)
summary(rb.glm2)

rb.glm3 <- glm(any_coinf_between ~ Host_genus, data = Xdata_genus_between, family = binomial)
summary(rb.glm3)

rb.glm4 <- glm(any_coinf_between ~ Host_species, data = Xdata_species_between, family = binomial)
summary(rb.glm4)
```

#### Logistic regression: Reduced taxonomic groups by counts; reference group is mode
```{r altreference.reduced.logreg}
# Any within-genus co-infection
rrw.glm1 <- glm(any_coinf_within ~ Host_order, data = Xdata_order_within, family = binomial)
summary(rrw.glm1)

rrw.glm2 <- glm(any_coinf_within ~ Host_family, data = Xdata_family_within, family = binomial)
summary(rrw.glm2)

rrw.glm3 <- glm(any_coinf_within ~ Host_genus, data = Xdata_genus_within, family = binomial)
summary(rrw.glm3)

rrw.glm4 <- glm(any_coinf_within ~ Host_species, data = Xdata_species_within, family = binomial)
summary(rrw.glm4)

# Any between-genera co-infection
rrb.glm1 <- glm(any_coinf_between ~ Host_order, data = Xdata_order_between, family = binomial)
summary(rrb.glm1)

rrb.glm2 <- glm(any_coinf_between ~ Host_family, data = Xdata_family_between, family = binomial)
summary(rrb.glm2)

rrb.glm3 <- glm(any_coinf_between ~ Host_genus, data = Xdata_genus_between, family = binomial)
summary(rrb.glm3)

rrb.glm4 <- glm(any_coinf_between ~ Host_species, data = Xdata_species_between, family = binomial)
summary(rrb.glm4)
```

#### Logistic regression: Reduced taxonomic groups by counts; reference group is mode; add covariates (Year, Country)
```{r cov.altreference.reduced.logreg}
# Any within-genus co-infection
crrw.glm1 <- glm(any_coinf_within ~ Host_order + Year + Country, data = Xdata_order_within, family = binomial)
summary(crrw.glm1)

# Compare coefficients to model using full data - very small differences only
# malaria$Host_order <- relevel(as.factor(malaria$Host_order), "Passeriformes")
# mod <- glm(any_coinf_within ~ Host_order + Year + Country, data = malaria, family = binomial)
# summary(mod)

crrw.glm2 <- glm(any_coinf_within ~ Host_family + Year + Country, data = Xdata_family_within, family = binomial)
summary(crrw.glm2)

crrw.glm3 <- glm(any_coinf_within ~ Host_genus + Year + Country, data = Xdata_genus_within, family = binomial)
summary(crrw.glm3)

crrw.glm4 <- glm(any_coinf_within ~ Host_species + Year + Country, data = Xdata_species_within, family = binomial)
summary(crrw.glm4)

# Any between-genera co-infection
crrb.glm1 <- glm(any_coinf_between ~ Host_order + Year + Country, data = Xdata_order_between, family = binomial)
summary(crrb.glm1)

crrb.glm2 <- glm(any_coinf_between ~ Host_family + Year + Country, data = Xdata_family_between, family = binomial)
summary(crrb.glm2)

crrb.glm3 <- glm(any_coinf_between ~ Host_genus + Year + Country, data = Xdata_genus_between, family = binomial)
summary(crrb.glm3)

crrb.glm4 <- glm(any_coinf_between ~ Host_species + Year + Country, data = Xdata_species_between, family = binomial)
summary(crrb.glm4)
```

#### Tables for logistic regression output
```{r logreg.table1}
logreg.1 <- data.frame(Effects = c("Coliiformes", "Columbiformes", "Coraciiformes",
                                 "Piciformes", "Year", "DRC", "Malawi",
                                 "Mozambique", "Uganda"),
                       effectcats = c(rep("Order (reference = Passeriformes)", 4), 
                                      "Year", 
                                      rep("Country (reference = Kenya)", 4)),
                       Coefs = coef(summary(crrw.glm1))[-1, 1],
                       oddsratios = exp(coef(summary(crrw.glm1))[-1, 1]),
                       lower.ci = exp(confint(crrw.glm1)[-1,1]),
                       upper.ci = exp(confint(crrw.glm1)[-1,2]),
                       pvals = coef(summary(crrw.glm1))[-1, 4])

logreg.tab1 <- logreg.1 %>% gt(rowname_col = "Effects", groupname_col = "effectcats") %>% 
  tab_stubhead(label = md("**Effects**")) %>%
  tab_header(title = md("**Table 10.** *Within*-Genus Co-Infection Odds Ratios and Confidence Intervals for Avian Host Orders"),
             subtitle = md("Output from Multivariate Logistic Regression")) %>%
  fmt_number(columns = c(Coefs, oddsratios), decimals = 2) %>%
  fmt_number(columns = c(pvals), decimals = 3) %>%
  fmt_number(columns = c(lower.ci), decimals = 2, pattern = "[{x},") %>%
  fmt_number(columns = c(upper.ci), decimals = 2, pattern = "{x}]") %>%
  cols_align(columns = c(Coefs, pvals, oddsratios), align = "center") %>%
  cols_align(columns = lower.ci, align = "right") %>%
  cols_align(columns = upper.ci, align = "left") %>%
  tab_spanner(label = md("*95% Confidence Interval*"),
              columns = c(lower.ci, upper.ci)) %>%
  cols_label(Coefs = md("*Log-odds ratio*"),
             pvals = md("*p-value*"),
             oddsratios = md("*Odds ratio*"),
             lower.ci = "",
             upper.ci = "") %>%
  cols_width(Coefs ~ px(100),
             pvals ~ px(100),
             oddsratios ~ px(100),
             lower.ci ~ px(70),
             upper.ci ~ px(70),
             Effects ~ px(200)) %>%
  opt_align_table_header(align = "left") %>%
  data_color(columns = pvals,
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
logreg.tab1

gtsave(logreg.tab1, "Within-Genus LogReg Order.png")
```

```{r logreg.table2}
logreg.2 <- data.frame(Effects = c(sort(levels(Xdata_family_within$Host_family)[-1]),
                                   "Year", "DRC", "Malawi", "Mozambique", "Uganda"),
                       effectcats = c(rep("Family (reference = Pycnonotidae)", 19), 
                                      "Year", 
                                      rep("Country (reference = Kenya)", 4)),
                       Coefs = coef(summary(crrw.glm2))[-1, 1],
                       oddsratios = exp(coef(summary(crrw.glm2))[-1, 1]),
                       lower.ci = exp(confint(crrw.glm2)[-1,1]),
                       upper.ci = exp(confint(crrw.glm2)[-1,2]),
                       pvals = coef(summary(crrw.glm2))[-1, 4])

logreg.tab2 <- logreg.2 %>% gt(rowname_col = "Effects", groupname_col = "effectcats") %>% 
  tab_stubhead(label = md("**Effects**")) %>%
  tab_header(title = md("**Table 12.** *Within*-Genus Co-Infection Odds Ratios and Confidence Intervals for Avian Host Families"),
             subtitle = md("Output from Multivariate Logistic Regression")) %>%
  fmt_number(columns = c(Coefs, oddsratios), decimals = 2) %>%
  fmt_number(columns = c(pvals), decimals = 3) %>%
  fmt_number(columns = c(lower.ci), decimals = 2, pattern = "[{x},") %>%
  fmt_number(columns = c(upper.ci), decimals = 2, pattern = "{x}]") %>%
  cols_align(columns = c(Coefs, pvals, oddsratios), align = "center") %>%
  cols_align(columns = lower.ci, align = "right") %>%
  cols_align(columns = upper.ci, align = "left") %>%
  tab_spanner(label = md("*95% Confidence Interval*"),
              columns = c(lower.ci, upper.ci)) %>%
  cols_label(Coefs = md("*Log-odds ratio*"),
             pvals = md("*p-value*"),
             oddsratios = md("*Odds ratio*"),
             lower.ci = "",
             upper.ci = "") %>%
  cols_width(Coefs ~ px(100),
             pvals ~ px(100),
             oddsratios ~ px(100),
             lower.ci ~ px(70),
             upper.ci ~ px(70),
             Effects ~ px(200)) %>%
  opt_align_table_header(align = "left") %>%
  data_color(columns = pvals,
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
logreg.tab2

gtsave(logreg.tab2, "Within-Genus LogReg Family.png")
```

```{r logreg.table3}
logreg.3 <- data.frame(Effects = c(sort(levels(Xdata_genus_within$Host_genus)[-1]),
                                   "Year", "DRC", "Malawi", "Mozambique", "Uganda"),
                       effectcats = c(rep("Gebus (reference = Calandrella)", 17), 
                                      "Year", 
                                      rep("Country (reference = Kenya)", 4)),
                       Coefs = coef(summary(crrw.glm3))[-1, 1],
                       oddsratios = exp(coef(summary(crrw.glm3))[-1, 1]),
                       lower.ci = exp(confint(crrw.glm3)[-1, 1]),
                       upper.ci = exp(confint(crrw.glm3)[-1, 2]),
                       pvals = coef(summary(crrw.glm3))[-1, 4])

logreg.tab3 <- logreg.3 %>% gt(rowname_col = "Effects", groupname_col = "effectcats") %>% 
  tab_stubhead(label = md("**Effects**")) %>%
  tab_header(title = md("**Table 14.** *Within*-Genus Co-Infection Odds Ratios and Confidence Intervals for Avian Host Genera"),
             subtitle = md("Output from Multivariate Logistic Regression")) %>%
  fmt_number(columns = c(Coefs, oddsratios), decimals = 2) %>%
  fmt_number(columns = c(pvals), decimals = 3) %>%
  fmt_number(columns = c(lower.ci), decimals = 2, pattern = "[{x},") %>%
  fmt_number(columns = c(upper.ci), decimals = 2, pattern = "{x}]") %>%
  cols_align(columns = c(Coefs, pvals, oddsratios), align = "center") %>%
  cols_align(columns = lower.ci, align = "right") %>%
  cols_align(columns = upper.ci, align = "left") %>%
  tab_spanner(label = md("*95% Confidence Interval*"),
              columns = c(lower.ci, upper.ci)) %>%
  cols_label(Coefs = md("*Log-odds ratio*"),
             pvals = md("*p-value*"),
             oddsratios = md("*Odds ratio*"),
             lower.ci = "",
             upper.ci = "") %>%
  cols_width(Coefs ~ px(100),
             pvals ~ px(100),
             oddsratios ~ px(100),
             lower.ci ~ px(70),
             upper.ci ~ px(70),
             Effects ~ px(200)) %>%
  opt_align_table_header(align = "left") %>%
  data_color(columns = pvals,
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
logreg.tab3

gtsave(logreg.tab3, "Within-Genus LogReg Genus.png")
```

```{r logreg.table4}
logreg.4 <- data.frame(Effects = c(sort(levels(Xdata_species_within$Host_species)[-1]),
                                   "Year", "DRC", "Malawi", "Mozambique", "Uganda"),
                       effectcats = c(rep("Species (reference = cinerea)", 5), 
                                      "Year", 
                                      rep("Country (reference = Kenya)", 4)),
                       Coefs = coef(summary(crrw.glm4))[-1, 1],
                       oddsratios = exp(coef(summary(crrw.glm4))[-1, 1]),
                       lower.ci = exp(confint(crrw.glm4)[-1, 1]),
                       upper.ci = exp(confint(crrw.glm4)[-1, 2]),
                       pvals = coef(summary(crrw.glm4))[-1, 4])

logreg.tab4 <- logreg.4 %>% gt(rowname_col = "Effects", groupname_col = "effectcats") %>% 
  tab_stubhead(label = md("**Effects**")) %>%
  tab_header(title = md("**Table 16.** *Within*-Genus Co-Infection Odds Ratios and Confidence Intervals for Avian Host Species"),
             subtitle = md("Output from Multivariate Logistic Regression")) %>%
  fmt_number(columns = c(Coefs, oddsratios), decimals = 2) %>%
  fmt_number(columns = c(pvals), decimals = 3) %>%
  fmt_number(columns = c(lower.ci), decimals = 2, pattern = "[{x},") %>%
  fmt_number(columns = c(upper.ci), decimals = 2, pattern = "{x}]") %>%
  cols_align(columns = c(Coefs, pvals, oddsratios), align = "center") %>%
  cols_align(columns = lower.ci, align = "right") %>%
  cols_align(columns = upper.ci, align = "left") %>%
  tab_spanner(label = md("*95% Confidence Interval*"),
              columns = c(lower.ci, upper.ci)) %>%
  cols_label(Coefs = md("*Log-odds ratio*"),
             pvals = md("*p-value*"),
             oddsratios = md("*Odds ratio*"),
             lower.ci = "",
             upper.ci = "") %>%
  cols_width(Coefs ~ px(100),
             pvals ~ px(100),
             oddsratios ~ px(90),
             lower.ci ~ px(70),
             upper.ci ~ px(80),
             Effects ~ px(200)) %>%
  opt_align_table_header(align = "left") %>%
  data_color(columns = pvals,
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
logreg.tab4

gtsave(logreg.tab4, "Within-Genus LogReg Species.png")
```

```{r logreg.table5}
logreg.5 <- data.frame(Effects = c(sort(levels(Xdata_order_between$Host_order)[-1]),
                                   "Year", "DRC", "Malawi", "Mozambique", "Uganda"),
                       effectcats = c(rep("Order (reference = Passeriformes)", 3), 
                                      "Year", 
                                      rep("Country (reference = Kenya)", 4)),
                       Coefs = coef(summary(crrb.glm1))[-1, 1],
                       oddsratios = exp(coef(summary(crrb.glm1))[-1, 1]),
                       lower.ci = exp(confint(crrb.glm1)[-1,1]),
                       upper.ci = exp(confint(crrb.glm1)[-1,2]),
                       pvals = coef(summary(crrb.glm1))[-1, 4])

logreg.tab5 <- logreg.5 %>% gt(rowname_col = "Effects", groupname_col = "effectcats") %>% 
  tab_stubhead(label = md("**Effects**")) %>%
  tab_header(title = md("**Table 11.** *Between*-Genus Co-Infection Odds Ratios and Confidence Intervals for Avian Host Orders"),
             subtitle = md("Output from Multivariate Logistic Regression")) %>%
  fmt_number(columns = c(Coefs, oddsratios), decimals = 2) %>%
  fmt_number(columns = c(pvals), decimals = 3) %>%
  fmt_number(columns = c(lower.ci), decimals = 2, pattern = "[{x},") %>%
  fmt_number(columns = c(upper.ci), decimals = 2, pattern = "{x}]") %>%
  cols_align(columns = c(Coefs, pvals, oddsratios), align = "center") %>%
  cols_align(columns = lower.ci, align = "right") %>%
  cols_align(columns = upper.ci, align = "left") %>%
  tab_spanner(label = md("*95% Confidence Interval*"),
              columns = c(lower.ci, upper.ci)) %>%
  cols_label(Coefs = md("*Log-odds ratio*"),
             pvals = md("*p-value*"),
             oddsratios = md("*Odds ratio*"),
             lower.ci = "",
             upper.ci = "") %>%
  cols_width(Coefs ~ px(100),
             pvals ~ px(100),
             oddsratios ~ px(100),
             lower.ci ~ px(70),
             upper.ci ~ px(70),
             Effects ~ px(200)) %>%
  opt_align_table_header(align = "left") %>%
  data_color(columns = pvals,
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
logreg.tab5

gtsave(logreg.tab5, "Between-Genus LogReg Order.png")
```

```{r logreg.table6}
logreg.6 <- data.frame(Effects = c(sort(levels(Xdata_family_between$Host_family)[-1]),
                                   "Year", "DRC", "Malawi", "Mozambique", "Uganda"),
                       effectcats = c(rep("Family (reference = Pycnonotidae)", 14), 
                                      "Year", 
                                      rep("Country (reference = Kenya)", 4)),
                       Coefs = coef(summary(crrb.glm2))[-1, 1],
                       oddsratios = exp(coef(summary(crrb.glm2))[-1, 1]),
                       lower.ci = exp(confint(crrb.glm2)[-1,1]),
                       upper.ci = exp(confint(crrb.glm2)[-1,2]),
                       pvals = coef(summary(crrb.glm2))[-1, 4])

logreg.tab6 <- logreg.6 %>% gt(rowname_col = "Effects", groupname_col = "effectcats") %>% 
  tab_stubhead(label = md("**Effects**")) %>%
  tab_header(title = md("**Table 13.** *Between*-Genus Co-Infection Odds Ratios and Confidence Intervals for Avian Host Families"),
             subtitle = md("Output from Multivariate Logistic Regression")) %>%
  fmt_number(columns = c(Coefs, oddsratios), decimals = 2) %>%
  fmt_number(columns = c(pvals), decimals = 3) %>%
  fmt_number(columns = c(lower.ci), decimals = 2, pattern = "[{x},") %>%
  fmt_number(columns = c(upper.ci), decimals = 2, pattern = "{x}]") %>%
  cols_align(columns = c(Coefs, pvals, oddsratios), align = "center") %>%
  cols_align(columns = lower.ci, align = "right") %>%
  cols_align(columns = upper.ci, align = "left") %>%
  tab_spanner(label = md("*95% Confidence Interval*"),
              columns = c(lower.ci, upper.ci)) %>%
  cols_label(Coefs = md("*Log-odds ratio*"),
             pvals = md("*p-value*"),
             oddsratios = md("*Odds ratio*"),
             lower.ci = "",
             upper.ci = "") %>%
  cols_width(Coefs ~ px(100),
             pvals ~ px(100),
             oddsratios ~ px(100),
             lower.ci ~ px(70),
             upper.ci ~ px(70),
             Effects ~ px(200)) %>%
  opt_align_table_header(align = "left") %>%
  data_color(columns = pvals,
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
logreg.tab6

gtsave(logreg.tab6, "Between-Genus LogReg Family.png")
```

```{r logreg.table7}
logreg.7 <- data.frame(Effects = c(sort(levels(Xdata_genus_between$Host_genus)[-1]),
                                   "Year", "DRC", "Malawi", "Mozambique", "Uganda"),
                       effectcats = c(rep("Genus (reference = Calandrella)", 11), 
                                      "Year", 
                                      rep("Country (reference = Kenya)", 4)),
                       Coefs = coef(summary(crrb.glm3))[-1, 1],
                       oddsratios = exp(coef(summary(crrb.glm3))[-1, 1]),
                       lower.ci = exp(confint(crrb.glm3)[-1, 1]),
                       upper.ci = exp(confint(crrb.glm3)[-1, 2]),
                       pvals = coef(summary(crrb.glm3))[-1, 4])

logreg.tab7 <- logreg.7 %>% gt(rowname_col = "Effects", groupname_col = "effectcats") %>% 
  tab_stubhead(label = md("**Effects**")) %>%
  tab_header(title = md("**Table 15.** *Between*-Genus Co-Infection Odds Ratios and Confidence Intervals for Avian Host Genera"),
             subtitle = md("Output from Multivariate Logistic Regression")) %>%
  fmt_number(columns = c(Coefs, oddsratios), decimals = 2) %>%
  fmt_number(columns = c(pvals), decimals = 3) %>%
  fmt_number(columns = c(lower.ci), decimals = 2, pattern = "[{x},") %>%
  fmt_number(columns = c(upper.ci), decimals = 2, pattern = "{x}]") %>%
  cols_align(columns = c(Coefs, pvals, oddsratios), align = "center") %>%
  cols_align(columns = lower.ci, align = "right") %>%
  cols_align(columns = upper.ci, align = "left") %>%
  tab_spanner(label = md("*95% Confidence Interval*"),
              columns = c(lower.ci, upper.ci)) %>%
  cols_label(Coefs = md("*Log-odds ratio*"),
             pvals = md("*p-value*"),
             oddsratios = md("*Odds ratio*"),
             lower.ci = "",
             upper.ci = "") %>%
  cols_width(Coefs ~ px(100),
             pvals ~ px(100),
             oddsratios ~ px(100),
             lower.ci ~ px(70),
             upper.ci ~ px(70),
             Effects ~ px(200)) %>%
  opt_align_table_header(align = "left") %>%
  data_color(columns = pvals,
             colors = scales::col_numeric(
               palette = c("lightgreen", rep("lightgray", 9)),
               domain = c(0, 1)))
logreg.tab7

gtsave(logreg.tab7, "Between-Genus LogReg Genus.png")
```


#### Nested logistic regression:
```{r nested.logreg}
## Within-genus coinfection
nested1 <- glmer(any_coinf_within ~ (1 | Host_order / Host_family), 
                control = glmerControl(optimizer = "bobyqa"), 
                 data = Xdata_order_within, family = binomial)
summary(nested1)

nested2 <- glmer(any_coinf_within ~ (1 | Host_order / Host_family / Host_genus),
                control = glmerControl(optimizer = "bobyqa"), 
                 data = Xdata_order_within, family = binomial)
summary(nested2)

nested3 <- glmer(any_coinf_within ~ (1 | Host_order / Host_family / Host_genus / Host_species),  # TAKES A WHILE TO RUN
                 control = glmerControl(optimizer = "bobyqa"), 
                 data = Xdata_order_within, family = binomial)
summary(nested3)

aov1 <- anova(nested3, nested2)
aov2 <- anova(nested2, nested1)
aov3 <- anova(nested1, nested3)

# plot(nested1, resid(., type = "pearson") ~ fitted(.) | any_coinf_within) ## (https://slcladal.github.io/regression.html)

## Between-genus coinfection
nested4 <- glmer(any_coinf_between ~ (1 | Host_order / Host_family), 
                 control = glmerControl(optimizer = "bobyqa"), 
                 data = Xdata_order_between, family = binomial)
summary(nested4)

nested5 <- glmer(any_coinf_between ~ (1 | Host_order / Host_family / Host_genus),
                 control = glmerControl(optimizer = "bobyqa"), 
                 data = Xdata_order_between, family = binomial)
summary(nested5)

nested6 <- glmer(any_coinf_between ~ (1 | Host_order / Host_family / Host_genus / Host_species),
                 control = glmerControl(optimizer = "bobyqa"), 
                 data = Xdata_order_between, family = binomial)
summary(nested6)

aov4 <- anova(nested6, nested5)
aov5 <- anova(nested5, nested4)
aov6 <- anova(nested4, nested6)

summary(nested6)

```


```{r table.nested.logreg}
summary.nested <- data.frame(
  order.variance = c(0.5452, 0.7291, 0.8685, 0.0000, 0.0000, 0.0000),
  family.variance = c(0.3164, 0.3470, 0.4303, 0.0936, 0.182, 0.965),
  genus.variance = c(0.0629, 0.1993, "-", 0.3567, 1.079, "-"),
  species.variance = c(0.4353, "-", "-", 1.0188, "-", "-"),
  chisq = c(NA, round(aov1$"Chisq"[2], 2), round(aov2$"Chisq"[2], 2),
            NA, round(aov4$"Chisq"[2], 2), round(aov5$"Chisq"[2], 2)),
  pvalue = c(NA, round(aov1$"Pr(>Chisq)"[2], 3), round(aov2$"Pr(>Chisq)"[2], 3),
             NA, round(aov4$"Pr(>Chisq)"[2], 3), round(aov5$"Pr(>Chisq)"[2], 3)),
  AIC = c(round(aov1$"AIC"[2], 1), round(aov1$"AIC"[1], 1), round(aov2$"AIC"[1], 1),
          round(aov4$"AIC"[2], 1), round(aov4$"AIC"[1], 1), round(aov5$"AIC"[1], 1)),
  model = rep(c("Order in Family in Genus in Species", "Order in Family in Genus", 
                "Order in Family"), times = 2),
  outcome = rep(c("Within-genus co-infection", "Between-genus co-infection"), 
                each = 3))

summary.nested.table <- summary.nested %>% 
  gt(rowname_col = "model", groupname_col = "outcome") %>% 
  tab_stubhead(label = md("**Nested Factors in Model**")) %>%
  tab_header(title = md("**Table 17.** Summary of ANOVA Results for Full and Reduced Generalized \nMixed Effect Regression Models")) %>%
  tab_spanner(label = md("*Random Effect Variance Component*"),
              columns = c(order.variance, family.variance, genus.variance, 
                         species.variance)) %>%
  cols_align(columns = c(order.variance, family.variance, genus.variance, 
                         species.variance, chisq, pvalue, AIC), 
             align = "center") %>%
  cols_label(order.variance = md("Order"),
             family.variance = md("Familiy"),
             genus.variance = md("Genus"), 
             species.variance = md("Species"), 
             chisq = md("*Chi-squared \nstatistic*"),
             pvalue = md("*p-value*"),
             AIC = md("*AIC*")) %>%
  cols_width(order.variance ~ px(70),
             family.variance ~ px(70),
             genus.variance ~ px(70),
             species.variance ~ px(70),
             chisq ~ px(80),
             pvalue ~ px(70),
             AIC ~ px(80),
             model ~ px(300)) %>%
  tab_style(cell_text(style = "oblique"), cells_row_groups()) %>%
  opt_align_table_header(align = "left")

summary.nested.table

gtsave(summary.nested.table, "Nested Models Summary Table.png")


```


## 4. Does the likelihood of co-infection vary by malaria lineages?

```{r}

```

## Appendix: Methods we tried that didn't work out

#### Within-genus bootstrapping: Among infected birds

```{r}
N <- 3418
set.seed(94)

## Leucocytozoon
p_L

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_l == 2 | newB$posdesig_l == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
              sum(newB$positive_l, na.rm = T)
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_l, na.rm = T)) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_l, na.rm = T))
}

phatLB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatLB <- mean(lowerciB)
upperhatLB <- mean(upperciB)

cat("Leuco:", phatLB, lowerhatLB, upperhatLB)

## Haemoproteus
p_H

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_h == 2 | newB$posdesig_h == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
              sum(newB$positive_h, na.rm = T)
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_h, na.rm = T)) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_h, na.rm = T))
}

phatHB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatHB <- mean(lowerciB)
upperhatHB <- mean(upperciB)

cat("Haemo:", phatHB, lowerhatHB, upperhatHB)


## Plasmodium
p_P

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_p == 2 | newB$posdesig_p == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
              sum(newB$positive_p, na.rm = T)
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_p, na.rm = T)) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_p, na.rm = T))
}

phatPB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatPB <- mean(lowerciB)
upperhatPB <- mean(upperciB)

cat("Plasmodium:", phatPB, lowerhatPB, upperhatPB)
```

#### Within-genus bootstrapping: Among screened birds

```{r}
N <- 3418
set.seed(94)

## Leucocytozoon
p2_L

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_l == 2 | newB$posdesig_l == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
               sum(malaria$screened_l == "Yes")
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_l == "Yes")) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_l == "Yes"))
}

phat2LB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhat2LB <- mean(lowerciB)
upperhat2LB <- mean(upperciB)

cat("Leuco:", phat2LB, lowerhat2LB, upperhat2LB)

## Haemoproteus
p2_H

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_h == 2 | newB$posdesig_h == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
               sum(malaria$screened_h == "Yes")
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_h == "Yes")) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_h == "Yes"))
}

phat2HB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhat2HB <- mean(lowerciB)
upperhat2HB <- mean(upperciB)

cat("Haemo:", phat2HB, lowerhat2HB, upperhat2HB)


## Plasmodium
p2_P

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_p == 2 | newB$posdesig_p == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
               sum(malaria$screened_p == "Yes")
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_p == "Yes")) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_p == "Yes"))
}

phat2PB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhat2PB <- mean(lowerciB)
upperhat2PB <- mean(upperciB)

cat("Plasmodium:", phat2PB, lowerhat2PB, upperhat2PB)
```

#### Between-genus bootstrapping: Among infected birds

```{r}
N <- 3418
set.seed(94)

nsim <- 1500              # Set number of runs for bootstrap samples
infectedB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
coinfectedB  <- rep(NA, nsim)
pB  <- rep(NA, nsim)
lowerB <- rep(NA, nsim)
upperB <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  infectedB[i] <- sum(newB$positive_l == 1 | 
                      newB$positive_h == 1 | 
                      newB$positive_p == 1, na.rm = T)
  coinfectedB[i] <- sum((newB$positive_l == 1 & newB$positive_h == 1) | 
                        (newB$positive_l == 1 & newB$positive_p == 1) |
                        (newB$positive_h == 1 & newB$positive_p == 1), na.rm = T)
  pB[i] <- coinfectedB[i] / infectedB[i]
  lowerB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / infectedB[i])
  upperB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / infectedB[i])
}

phatB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatB <- mean(lowerB)
upperhatB <- mean(upperB)

cat("Among infected birds:", phatB, lowerhatB, upperhatB)
```

#### Between-genus bootstrapping: Among all birds screened

```{r}
N <- 3418
set.seed(94)

nsim <- 1500              # Set number of runs for bootstrap samples
infectedB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
coinfectedB  <- rep(NA, nsim)
pB  <- rep(NA, nsim)
lowerB <- rep(NA, nsim)
upperB <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  screened_all <- sum(newB$screened_l=="Yes")
  coinfectedB[i] <- sum((newB$positive_l == 1 & newB$positive_h == 1) | 
                        (newB$positive_l == 1 & newB$positive_p == 1) |
                        (newB$positive_h == 1 & newB$positive_p == 1), na.rm = T)
  pB[i] <- coinfectedB[i] / screened_all
  lowerB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / screened_all)
  upperB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / screened_all)
}

phatB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatB <- mean(lowerB)
upperhatB <- mean(upperB)

cat("Among all birds screened:", phatB, lowerhatB, upperhatB)
```

#### k-means Clustering
```{r clustering.elevation}
## Order
cl.table1 <- malaria[, c('Host_order', 'Elevation', 'coinf_within_order')]
cl.table1 <- cl.table1[!is.na(cl.table1$Elevation),]
cluster1 <- kmeans(cl.table1[,c(2,3)], centers = 3)
plot(cl.table1$Elevation, cl.table1$coinf_within_order, col = cluster1$cluster)

cl.table2 <- malaria[, c('Host_order', 'Elevation', 'coinf_between_order')]
cl.table2 <- cl.table2[!is.na(cl.table2$Elevation),]
cluster2 <- kmeans(cl.table2[,c(2,3)], centers = 3)
plot(cl.table2$Elevation, cl.table2$coinf_between_order, col = cluster2$cluster)

## Species
cl.table1 <- malaria[, c('Host_order', 'Elevation', 'coinf_within_species')]
cl.table1 <- cl.table1[!is.na(cl.table1$Elevation),]
cluster1 <- kmeans(cl.table1[,c(2,3)], centers = 5)
plot(cl.table1$Elevation, cl.table1$coinf_within_species, col = cluster1$cluster)

cl.table2 <- malaria[, c('Host_order', 'Elevation', 'coinf_between_species')]
cl.table2 <- cl.table2[!is.na(cl.table2$Elevation),]
cluster2 <- kmeans(cl.table2[,c(2,3)], centers = 5)
plot(cl.table2$Elevation, cl.table2$coinf_between_species, col = cluster2$cluster)
```

```{r clustering.year}
## Order
cl.table1 <- malaria[, c('Host_order', 'Year', 'coinf_within_order')]
cl.table1 <- cl.table1[!is.na(cl.table1$Year),]
cluster1 <- kmeans(cl.table1[,c(2,3)], centers = 5)
plot(jitter(cl.table1$Year), jitter(cl.table1$coinf_within_order), col = cluster1$cluster)

cl.table2 <- malaria[, c('Host_order', 'Year', 'coinf_between_order')]
cl.table2 <- cl.table2[!is.na(cl.table2$Year),]
cluster2 <- kmeans(cl.table2[,c(2,3)], centers = 5)
plot(jitter(cl.table2$Year), jitter(cl.table2$coinf_between_order), col = cluster2$cluster)

## Species
cl.table3 <- malaria[, c('Host_species', 'Year', 'coinf_within_species')]
cl.table3 <- cl.table3[!is.na(cl.table3$Year),]
cluster3 <- kmeans(cl.table3[,c(2,3)], centers = 5)
plot(jitter(cl.table3$Year), jitter(cl.table3$coinf_within_species), col = cluster3$cluster)

cl.table4 <- malaria[, c('Host_species', 'Year', 'coinf_between_species')]
cl.table4 <- cl.table4[!is.na(cl.table4$Year),]
cluster4 <- kmeans(cl.table4[,c(2,3)], centers = 5)
plot(jitter(cl.table4$Year), jitter(cl.table4$coinf_between_species), col = cluster4$cluster)
```





## OLD CODE

```{r}
## Logistic regressions ########################################################
# Leucocytozoon
Lglm1 <- glm.nb(leuco_coinf ~ I(Host_order), data = malaria)
summary(Lglm1)

Lglm2 <- glm(leuco_coinf ~ Host_family, data = malaria, family = binomial)
summary(Lglm2)

Lglm2 <- glm.nb(leuco_coinf ~ Host_family, data = malaria)
summary(Lglm2)

Lglm3 <- glm.nb(leuco_coinf ~ Host_genus, data = malaria)
summary(Lglm3)

# Haemoproteus
Hglm1 <- glm(haemo_coinf ~ Host_order, data = malaria, family = binomial)
summary(Hglm1)

Hglm2 <- glm(haemo_coinf ~ Host_family, data = malaria, family = binomial)
summary(Hglm2)

Hglm3 <- glm(haemo_coinf ~ Host_genus, data = malaria, family = binomial)
summary(Hglm3)

# Plasmodium
Pglm1 <- glm(plas_coinf ~ Host_order, data = malaria, family = binomial)
summary(Pglm1)

Pglm2 <- glm(plas_coinf ~ Host_family, data = malaria, family = binomial)
summary(Pglm2)

Pglm3 <- glm(plas_coinf ~ Host_genus, data = malaria, family = binomial)
summary(Pglm3)

#### CLUSTERING FOR FAMILY AND GENUS (ELEVATION)
## Family
cl.table1 <- malaria[, c('Host_family', 'Elevation', 'coinf_within_family')]
cl.table1 <- cl.table1[!is.na(cl.table1$Elevation),]
cluster1 <- kmeans(cl.table1[,c(2,3)], centers = 4)
plot(cl.table1$Elevation, cl.table1$coinf_within_family, col = cluster1$cluster)

cl.table2 <- malaria[, c('Host_family', 'Elevation', 'coinf_between_family')]
cl.table2 <- cl.table2[!is.na(cl.table2$Elevation),]
cluster2 <- kmeans(cl.table2[,c(2,3)], centers = 4)
plot(cl.table2$Elevation, cl.table2$coinf_between_family, col = cluster2$cluster)

## Genus
cl.table1 <- malaria[, c('Host_order', 'Elevation', 'coinf_within_genus')]
cl.table1 <- cl.table1[!is.na(cl.table1$Elevation),]
cluster1 <- kmeans(cl.table1[,c(2,3)], centers = 4)
plot(cl.table1$Elevation, cl.table1$coinf_within_genus, col = cluster1$cluster)

cl.table2 <- malaria[, c('Host_order', 'Elevation', 'coinf_between_genus')]
cl.table2 <- cl.table2[!is.na(cl.table2$Elevation),]
cluster2 <- kmeans(cl.table2[,c(2,3)], centers = 4)
plot(cl.table2$Elevation, cl.table2$coinf_between_genus, col = cluster2$cluster)


## Full models
glm.full.w <- glm(any_coinf_within ~ Host_order + Host_family + Host_genus +
                  Host_species + Year  + Country,
                data = Xdata_species_within, family = binomial)
summary(glm.full.w)

glm.full.b <- glm(any_coinf_within ~ Host_order + Host_family + Host_genus +
                  Host_species + Year  + Country,
                data = Xdata_species_between, family = binomial)
summary(glm.full.b)


```

