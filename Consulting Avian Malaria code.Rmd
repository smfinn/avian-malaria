---
title: "Consulting Avian Malaria"
author: "Sean Finn & Evelyn Lupancu"
date: "Updated 11/10/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
library(readxl)
library(tidyverse)
library(ggcorrplot)
library(grid)
library(gridExtra)
library(cluster)
library(gmodels)
theme_set(
  theme_minimal()
)
```

$\hat\pi \pm z_{0.025} * \sqrt{\dfrac{\hat\pi * (1 - \hat\pi)}{n}}$


```{r clean}
malaria <- read_excel("MalariaSampling_MasterFile_Sept23.xlsx")

# Rename long variables
malaria <- malaria %>% rename(screened_l = `Screened for Leuco`,
                              screened_h = `Screened for HAEM`,
                              screened_p = `Screened for Plas`,
                              positive_l = `Positive=1...21`,
                              positive_h = `Positive=1...27`,
                              positive_p = `Positive=1...33`,
                              posdesig_l = `Pos Designation...22`,
                              posdesig_h = `Pos Designation...28`,
                              posdesig_p = `Pos Designation...34`)

# Change elevation, latitude, and longitude variables to numeric
malaria$Elevation <- str_remove_all(malaria$Elevation, "m")
malaria$Elevation <- as.numeric(malaria$Elevation)
malaria$Lat <- as.numeric(malaria$Lat)
malaria$Long <- as.numeric(malaria$Long)

# Standardize sex reporting
malaria$Sex[malaria$Sex == "f"] <- "F"
malaria$Sex[malaria$Sex == "m"] <- "M"
malaria$Sex[malaria$Sex == "?"] <- "X"
malaria$Sex[malaria$Sex == "N"] <- "X"
malaria$Sex[malaria$Sex == "0"] <- "X"
malaria$Sex[malaria$Sex == "No BS"] <- "X"
table(malaria$Sex)

# Convert negative test results to zeros
malaria <- malaria %>% mutate(positive_l = ifelse(is.na(positive_l), 0, 1),
                              positive_h = ifelse(is.na(positive_h), 0, 1),
                              positive_p = ifelse(is.na(positive_p), 0, 1),
                              posdesig_l = ifelse(is.na(posdesig_l), 0, posdesig_l),
                              posdesig_h = ifelse(is.na(posdesig_h), 0, posdesig_h),
                              posdesig_p = ifelse(is.na(posdesig_p), 0, posdesig_p))

# Shorten Democratic Republic of the Congo (for visualizations)
malaria$Country[malaria$Country=="Democratic Republic Congo"] <- "DRC"

# Create variable for positive result from any genus
malaria$infected_any <- 0
malaria$infected_any[malaria$positive_p == 1 | malaria$positive_l == 1 | malaria$positive_h == 1] <- 1

# Create variables for within and between-genus co-infections
malaria$leuco_coinf <- ifelse(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, 1, 0)
malaria$haemo_coinf <- ifelse(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, 1, 0)
malaria$plas_coinf <- ifelse(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, 1, 0)
malaria$any_coinf_within <- ifelse(malaria$leuco_coinf == 1 | malaria$haemo_coinf == 1 | malaria$plas_coinf == 1,
                            1, 0)
malaria$any_coinf_between <- ifelse((
  (malaria$positive_l == 1 & malaria$positive_h == 1) | 
  (malaria$positive_l == 1 & malaria$positive_p == 1) |
  (malaria$positive_h == 1 & malaria$positive_p == 1)), 1, 0)

# Store numbers related to any malaria infection, co-infection, and screening
infected_all <- sum(malaria$positive_l == 1 | 
                    malaria$positive_h == 1 | 
                    malaria$positive_p == 1, na.rm = T)
coinfected_all <- sum((malaria$positive_l == 1 & malaria$positive_h == 1) | 
    (malaria$positive_l == 1 & malaria$positive_p == 1) |
    (malaria$positive_h == 1 & malaria$positive_p == 1), na.rm = T)
screened_all <- sum(malaria$screened_l=="Yes")

# Find co-infection rates by taxonomic groups
co <- as.data.frame(table(malaria$Host_order, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_order, malaria$any_coinf_between))
coinf_order <- data.frame(Host_order = co$Var1[co$Var2==0],
                          yes.w = as.numeric(co$Freq[co$Var2==1]),
                          no.w = as.numeric(co$Freq[co$Var2==0]),
                          yes.b = as.numeric(cb$Freq[co$Var2==1]),
                          no.b = as.numeric(cb$Freq[co$Var2==0]))
coinf_order$coinf_within_order <- coinf_order$yes.w / (coinf_order$yes.w + coinf_order$no.w)
coinf_order$coinf_between_order <- coinf_order$yes.b / (coinf_order$yes.b + coinf_order$no.b)
coinf_order <- coinf_order[,c("Host_order", "coinf_within_order", "coinf_between_order")]

co <- as.data.frame(table(malaria$Host_family, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_family, malaria$any_coinf_between))
coinf_family <- data.frame(Host_family = co$Var1[co$Var2==0],
                          yes.w = as.numeric(co$Freq[co$Var2==1]),
                          no.w = as.numeric(co$Freq[co$Var2==0]),
                          yes.b = as.numeric(cb$Freq[co$Var2==1]),
                          no.b = as.numeric(cb$Freq[co$Var2==0]))
coinf_family$coinf_within_family <- coinf_family$yes.w / (coinf_family$yes.w + coinf_family$no.w)
coinf_family$coinf_between_family <- coinf_family$yes.b / (coinf_family$yes.b + coinf_family$no.b)
coinf_family <- coinf_family[,c("Host_family", "coinf_within_family", "coinf_between_family")]

co <- as.data.frame(table(malaria$Host_genus, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_genus, malaria$any_coinf_between))
coinf_genus <- data.frame(Host_genus = co$Var1[co$Var2==0],
                          yes.w = as.numeric(co$Freq[co$Var2==1]),
                          no.w = as.numeric(co$Freq[co$Var2==0]),
                          yes.b = as.numeric(cb$Freq[co$Var2==1]),
                          no.b = as.numeric(cb$Freq[co$Var2==0]))
coinf_genus$coinf_within_genus <- coinf_genus$yes.w / (coinf_genus$yes.w + coinf_genus$no.w)
coinf_genus$coinf_between_genus <- coinf_genus$yes.b / (coinf_genus$yes.b + coinf_genus$no.b)
coinf_genus <- coinf_genus[,c("Host_genus", "coinf_within_genus", "coinf_between_genus")]

co <- as.data.frame(table(malaria$Host_species, malaria$any_coinf_within))
cb <- as.data.frame(table(malaria$Host_species, malaria$any_coinf_between))
coinf_species <- data.frame(Host_species = co$Var1[co$Var2==0],
                          yes.w = as.numeric(co$Freq[co$Var2==1]),
                          no.w = as.numeric(co$Freq[co$Var2==0]),
                          yes.b = as.numeric(cb$Freq[co$Var2==1]),
                          no.b = as.numeric(cb$Freq[co$Var2==0]))
coinf_species$coinf_within_species <- coinf_species$yes.w / (coinf_species$yes.w + coinf_species$no.w)
coinf_species$coinf_between_species <- coinf_species$yes.b / (coinf_species$yes.b + coinf_species$no.b)
coinf_species <- coinf_species[,c("Host_species", "coinf_within_species", "coinf_between_species")]

# Add co-infection rates to main data frame
malaria <- merge(malaria, coinf_order, by = "Host_order")
malaria <- merge(malaria, coinf_family, by = "Host_family")
malaria <- merge(malaria, coinf_genus, by = "Host_genus")
malaria <- merge(malaria, coinf_species, by = "Host_species")

```

## Exploratory Data Analysis

```{r}
table(malaria$Country)
table(malaria$District)
hist(malaria$Elevation)
```

```{r}
elevation <- ggplot(malaria, aes(Elevation)) +
  geom_histogram(bins = 15, fill = "forestgreen") +
  labs(title = "Elevation of Avian Samples",
       x = "Elevation", y = "Frequency") +
  scale_x_continuous(limits = c(0, 3000)) +
  theme_classic()
elevation
```

#### Infections by country
```{r}
leuco.country <- as.data.frame(table(malaria$positive_l, malaria$Country))
leuco_eda1 <- ggplot(leuco.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer() +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

leuco_eda2 <- ggplot(leuco.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

leuco_eda <- grid.arrange(leuco_eda1, leuco_eda2, nrow = 1, 
             top = "Leucocytozoon Positivity by Country")
ggsave("leucocytozoon by country.png", leuco_eda, width = 7, height = 4)
```

```{r}
haemo.country <- as.data.frame(table(malaria$positive_h, malaria$Country))
haemo_eda1 <- ggplot(haemo.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 4) +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

haemo_eda2 <- ggplot(haemo.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 4, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

haemo_eda <- grid.arrange(haemo_eda1, haemo_eda2, nrow = 1, 
             top = "Haemocrodius Positivity by Country")
ggsave("haemocrodius by country.png", haemo_eda, width = 7, height = 4)
```

```{r}
plas.country <- as.data.frame(table(malaria$positive_p, malaria$Country))
plas_eda1 <- ggplot(plas.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 7) +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

plas_eda2 <- ggplot(plas.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 7, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

plas_eda <- grid.arrange(plas_eda1, plas_eda2, nrow = 1, 
             top = "Plasmodium Positivity by Country")
ggsave("plasmodium by country.png", plas_eda, width = 7, height = 4)
```

#### Significance testing by country

```{r}
summary(glm(positive_l ~ Country, data = malaria, family = binomial))
summary(glm(positive_h ~ Country, data = malaria, family = binomial))
summary(glm(positive_p ~ Country, data = malaria, family = binomial))
summary(glm(infected_any ~ Country, data = malaria, family = binomial))
```


#### Infections by sex
```{r}
leuco.sex <- as.data.frame(table(malaria$positive_l[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
leuco_eda3 <- ggplot(leuco.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer() +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

leuco_eda4 <- ggplot(leuco.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

leuco_eda_sex <- grid.arrange(leuco_eda3, leuco_eda4, nrow = 1, 
             top = "Leucocytozoon Positivity by Sex")

ggsave("leucocytozoon by sex.png", leuco_eda_sex, width = 4, height = 3)
```

```{r}
haemo.sex <- as.data.frame(table(malaria$positive_h[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
haemo_eda3 <- ggplot(haemo.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 4) +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

haemo_eda4 <- ggplot(haemo.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 4, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

haemo_eda_sex <- grid.arrange(haemo_eda3, haemo_eda4, nrow = 1, 
             top = "Haemocrodius Positivity by Sex")
ggsave("haemocrodius by sex.png", haemo_eda_sex, width = 4, height = 3)
```

```{r}
plas.sex <- as.data.frame(table(malaria$positive_p[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
plas_eda3 <- ggplot(plas.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 7) +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

plas_eda4 <- ggplot(plas.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 7, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

plas_eda_sex <- grid.arrange(plas_eda3, plas_eda4, nrow = 1, 
             top = "Plasmodium Positivity by Sex")
ggsave("plasmodium by sex.png", plas_eda_sex, width = 4, height = 3)
```

#### Significance testing by sex

```{r}
summary(glm(positive_l ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
summary(glm(positive_h ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
summary(glm(positive_p ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
summary(glm(infected_any ~ Sex, data = malaria[malaria$Sex != "X",], family = binomial))
```


## 1. How often do co-infections occur within the same genera of avian malarial pathogens? 

#### *Among birds who are infected*

```{r}
total_n <- 3418

# Leucocytozoon
sum(malaria$screened_l == "Yes")   # How many screened
sum(malaria$positive_l, na.rm = T) # How many positive 
sum(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, na.rm = T)  # Co-infections
(p_L <- 198 / 749)
n_L <- 749
ci_L.lower <- p_L - qnorm(0.975) * sqrt((p_L * (1 - p_L)) / n_L)
ci_L.upper <- p_L + qnorm(0.975) * sqrt((p_L * (1 - p_L)) / n_L)
cat("95% confidence interval: [", round(c(ci_L.lower, ci_L.upper)*100, 2), "]")

# Haemocrodius
sum(malaria$screened_h == "Yes")   # How many screened
sum(malaria$positive_h, na.rm = T) # How many positive 
sum(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, na.rm = T)  # Co-infections
(p_H <- 51 / 348)
n_H <- 348
ci_H.lower <- p_H - qnorm(0.975) * sqrt((p_H * (1 - p_H)) / n_H)
ci_H.upper <- p_H + qnorm(0.975) * sqrt((p_H * (1 - p_H)) / n_H)
cat("95% confidence interval: [", round(c(ci_H.lower, ci_H.upper)*100, 2), "]")

# Plasmodium
sum(malaria$screened_p == "Yes")   # How many screened
sum(malaria$positive_p, na.rm = T) # How many positive 
sum(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, na.rm = T)  # Co-infections
(p_P <- 166 / 761)
n_P <- 761
ci_P.lower <- p_P - qnorm(0.975) * sqrt((p_P * (1 - p_P)) / n_P)
ci_P.upper <- p_P + qnorm(0.975) * sqrt((p_P * (1 - p_P)) / n_P)
cat("95% confidence interval: [", round(c(ci_P.lower, ci_P.upper)*100, 2), "]")
```

Leucocytozoon: [23.28%, 29.59%]
Haemocrodius: [10.94%, 18.37%]
Plasmodium: [18.88%, 24.75%]


```{r}
genera <- c("Leucocytozoon", "Haemocrodius", "Plasmodium")
y <- c(p_L*100, p_H*100, p_P*100)
ymin <- c(ci_L.lower*100, ci_H.lower*100, ci_P.lower*100)
ymax <- c(ci_L.upper*100, ci_H.upper*100, ci_P.upper*100)
wald_boxes <- as.data.frame(cbind(genera, y, ymin, ymax))
wald_boxes <- wald_boxes %>% mutate(y = as.numeric(y),
                                    ymin = as.numeric(ymin),
                                    ymax = as.numeric(ymax))

wald_boxes_chart <- ggplot(wald_boxes, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 30)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Frequency of Malaria Infection Frequency by Genus", 
       subtitle = "Among birds infected with genus",
       x = "Genus", y = "Percent of birds infected")
wald_boxes_chart

ggsave("frequency by genus1.png", wald_boxes_chart, height = 4.5, width = 5)
```

#### *Among all birds screened*

```{r}
total_n <- 3418

# Leucocytozoon
num_screened_l <- sum(malaria$screened_l == "Yes")   # How many screened
sum(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, na.rm = T)  # Co-infections
(p2_L <- 198 / num_screened_l)
ci2_L.lower <- p2_L - qnorm(0.975) * sqrt((p2_L * (1 - p2_L)) / num_screened_l)
ci2_L.upper <- p2_L + qnorm(0.975) * sqrt((p2_L * (1 - p2_L)) / num_screened_l)
cat("95% confidence interval: [", round(c(ci2_L.lower, ci2_L.upper)*100, 2), "]")

# Haemocrodius
sum(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, na.rm = T)  # Co-infections
(p2_H <- 51 / total_n)
ci2_H.lower <- p2_H - qnorm(0.975) * sqrt((p2_H * (1 - p2_H)) / total_n)
ci2_H.upper <- p2_H + qnorm(0.975) * sqrt((p2_H * (1 - p2_H)) / total_n)
cat("95% confidence interval: [", round(c(ci2_H.lower, ci2_H.upper)*100, 2), "]")

# Plasmodium
sum(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, na.rm = T)  # Co-infections
(p2_P <- 166 / total_n)
ci2_P.lower <- p2_P - qnorm(0.975) * sqrt((p2_P * (1 - p2_P)) / total_n)
ci2_P.upper <- p2_P + qnorm(0.975) * sqrt((p2_P * (1 - p2_P)) / total_n)
cat("95% confidence interval: [", round(c(ci2_P.lower, ci2_P.upper)*100, 2), "]")
```

```{r}
genera <- c("Leucocytozoon", "Haemocrodius", "Plasmodium")
y2 <- c(p2_L*100, p2_H*100, p2_P*100)
ymin2 <- c(ci2_L.lower*100, ci2_H.lower*100, ci2_P.lower*100)
ymax2 <- c(ci2_L.upper*100, ci2_H.upper*100, ci2_P.upper*100)
wald_boxes2 <- as.data.frame(cbind(genera, y2, ymin2, ymax2))
wald_boxes2 <- wald_boxes %>% mutate(y = as.numeric(y2),
                                    ymin = as.numeric(ymin2),
                                    ymax = as.numeric(ymax2))

wald_boxes_chart2 <- ggplot(wald_boxes2, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 8)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Frequency of Malaria Infection Frequency by Genus", 
       subtitle = "Among birds screened for genus", 
       x = "Genus", y = "Percent of birds infected")
wald_boxes_chart2

ggsave("frequency by genus2.png", wald_boxes_chart2, height = 4.5, width = 5)
```

Compare with using the negative binomial distribution for confidence intervals

#### Bootstrapping: Among infected birds

```{r}
N <- 3418
set.seed(94)

## Leucocytozoon
p_L

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_l == 2 | newB$posdesig_l == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
              sum(newB$positive_l, na.rm = T)
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_l, na.rm = T)) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_l, na.rm = T))
}

phatLB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatLB <- mean(lowerciB)
upperhatLB <- mean(upperciB)

cat("Leuco:", phatLB, lowerhatLB, upperhatLB)

## Haemocrodius
p_H

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_h == 2 | newB$posdesig_h == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
              sum(newB$positive_h, na.rm = T)
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_h, na.rm = T)) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_h, na.rm = T))
}

phatHB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatHB <- mean(lowerciB)
upperhatHB <- mean(upperciB)

cat("Haemo:", phatHB, lowerhatHB, upperhatHB)


## Plasmodium
p_P

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_p == 2 | newB$posdesig_p == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
              sum(newB$positive_p, na.rm = T)
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_p, na.rm = T)) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(newB$positive_p, na.rm = T))
}

phatPB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatPB <- mean(lowerciB)
upperhatPB <- mean(upperciB)

cat("Plasmodium:", phatPB, lowerhatPB, upperhatPB)
```

#### Bootstrapping: Among screened birds

```{r}
N <- 3418
set.seed(94)

## Leucocytozoon
p2_L

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_l == 2 | newB$posdesig_l == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
               sum(malaria$screened_l == "Yes")
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_l == "Yes")) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_l == "Yes"))
}

phat2LB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhat2LB <- mean(lowerciB)
upperhat2LB <- mean(upperciB)

cat("Leuco:", phat2LB, lowerhat2LB, upperhat2LB)

## Haemocrodius
p2_H

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_h == 2 | newB$posdesig_h == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
               sum(malaria$screened_h == "Yes")
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_h == "Yes")) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_h == "Yes"))
}

phat2HB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhat2HB <- mean(lowerciB)
upperhat2HB <- mean(upperciB)

cat("Haemo:", phat2HB, lowerhat2HB, upperhat2HB)


## Plasmodium
p2_P

nsim <- 1500              # Set number of runs for bootstrap samples
pB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
lowerciB  <- rep(NA, nsim)
upperciB  <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  pB[i] <- sum(newB$posdesig_p == 2 | newB$posdesig_p == 3, na.rm = T) /        # Calculate sample proportions, confidence intervals
               sum(malaria$screened_p == "Yes")
  lowerciB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_p == "Yes")) 
  upperciB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / sum(malaria$screened_p == "Yes"))
}

phat2PB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhat2PB <- mean(lowerciB)
upperhat2PB <- mean(upperciB)

cat("Plasmodium:", phat2PB, lowerhat2PB, upperhat2PB)
```



## 2. How often do co-infections occur between different genera of avian malarial pathogens?

#### *Among birds that tested positive for malaria*

```{r}
infected_all <- sum(malaria$positive_l == 1 | 
                    malaria$positive_h == 1 | 
                    malaria$positive_p == 1, na.rm = T)
coinfected_all <- sum((malaria$positive_l == 1 & malaria$positive_h == 1) | 
    (malaria$positive_l == 1 & malaria$positive_p == 1) |
    (malaria$positive_h == 1 & malaria$positive_p == 1), na.rm = T)
p3 <- coinfected_all / infected_all
ci3.lower <- p3 - qnorm(0.975) * sqrt((p3 * (1 - p3)) / infected_all)
ci3.upper <- p3 + qnorm(0.975) * sqrt((p3 * (1 - p3)) / infected_all)
cat("95% confidence interval: [", round(c(ci3.lower, ci3.upper)*100, 2), "]")
```

#### *Among all birds screened*

```{r}
screened_all <- sum(malaria$screened_l=="Yes") # Leuco is only genus that didn't get tested for all birds
p4 <- coinfected_all / screened_all
ci4.lower <- p4 - qnorm(0.975) * sqrt((p4 * (1 - p4)) / screened_all)
ci4.upper <- p4 + qnorm(0.975) * sqrt((p4 * (1 - p4)) / screened_all)
cat("95% confidence interval: [", round(c(ci4.lower, ci4.upper)*100, 2), "]")
```

#### Bootstrapping: Among infected birds

```{r}
N <- 3418
set.seed(94)

nsim <- 1500              # Set number of runs for bootstrap samples
infectedB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
coinfectedB  <- rep(NA, nsim)
pB  <- rep(NA, nsim)
lowerB <- rep(NA, nsim)
upperB <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  infectedB[i] <- sum(newB$positive_l == 1 | 
                      newB$positive_h == 1 | 
                      newB$positive_p == 1, na.rm = T)
  coinfectedB[i] <- sum((newB$positive_l == 1 & newB$positive_h == 1) | 
                        (newB$positive_l == 1 & newB$positive_p == 1) |
                        (newB$positive_h == 1 & newB$positive_p == 1), na.rm = T)
  pB[i] <- coinfectedB[i] / infectedB[i]
  lowerB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / infectedB[i])
  upperB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / infectedB[i])
}

phatB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatB <- mean(lowerB)
upperhatB <- mean(upperB)

cat("Among infected birds:", phatB, lowerhatB, upperhatB)
```


#### Bootstrapping: Among all birds screened

```{r}
N <- 3418
set.seed(94)

nsim <- 1500              # Set number of runs for bootstrap samples
infectedB  <- rep(NA, nsim)   # Initialize vectors to store bootstrap statistics
coinfectedB  <- rep(NA, nsim)
pB  <- rep(NA, nsim)
lowerB <- rep(NA, nsim)
upperB <- rep(NA, nsim)

for (i in 1:nsim) {
  newB <- malaria[sample(1:N, N, replace = TRUE),]    # Sample malaria observations with replacement
  screened_all <- sum(newB$screened_l=="Yes")
  coinfectedB[i] <- sum((newB$positive_l == 1 & newB$positive_h == 1) | 
                        (newB$positive_l == 1 & newB$positive_p == 1) |
                        (newB$positive_h == 1 & newB$positive_p == 1), na.rm = T)
  pB[i] <- coinfectedB[i] / screened_all
  lowerB[i] <- pB[i] - qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / screened_all)
  upperB[i] <- pB[i] + qnorm(0.975) * sqrt((pB[i] * (1 - pB[i])) / screened_all)
}

phatB <- mean(pB)           # Find mean of bootstrap vector for bootstrap proportion estimate
lowerhatB <- mean(lowerB)
upperhatB <- mean(upperB)

cat("Among all birds screened:", phatB, lowerhatB, upperhatB)
```


## 3. Are certain host birds more susceptible to co-infections than other hosts?

Start by looking into: Species, genus, family level
Remove groups that have less than 3 individuals, 5 individuals, 10 individuals - see what results look like
Pseudo-count (for many zeros in data) - look into this
Zero-inflated distributions, try other distributions

OUTCOME VARIABLE: Co-infection present (binary)
MODEL IDEAS:
- multivariate logistic regression
  + elastic net
  + main effect variable: species/genus/family (categorical)
  + would need to remove groups with low counts, not enough confidence

OUTCOME VARIABLE: Co-infection rate by species/genus/family
MODEL IDEAS:
- Clustering
- Prediction of co-infection with random forest using family co-infection rate as predictor
- Zero-inflated Beta regression

Look into nested models... (but are there enough obs in genus, species?)

CLUSTERING:
* k-means clustering

```{r}
# Number of unique taxonomic groups by level
length(unique(malaria$Host_order))
length(unique(malaria$Host_family))
length(unique(malaria$Host_genus))
length(unique(malaria$Host_species))
length(unique(malaria$Host_subspp))

# Tables of taxonomic groups by frequency
malaria %>% group_by(Host_family) %>% summarize(Count = n()) %>% arrange(desc(Count))
malaria %>% group_by(Host_genus) %>% summarize(Count = n()) %>% arrange(desc(Count))
malaria %>% group_by(Host_species) %>% summarize(Count = n()) %>% arrange(desc(Count))

# Convert number of groups by taxonomic level to data frames
order_freqs <- as.data.frame(table(malaria$Host_order))
family_freqs <- as.data.frame(table(malaria$Host_family))
genus_freqs <- as.data.frame(table(malaria$Host_genus))
species_freqs <- as.data.frame(table(malaria$Host_species))

# Create reduced version of data frames with counts of at least X!!!!![update me]
min <- 10
order_reduced <- order_freqs[order_freqs$Freq >= min,]
family_reduced <- family_freqs[family_freqs$Freq >= min,]
genus_reduced <- genus_freqs[genus_freqs$Freq >= min,]
species_reduced <- species_freqs[species_freqs$Freq >= min,]

# Prepare data for chi-squared test tables
Xdata_order <- malaria[malaria$Host_order %in% order_reduced$Var1,]
Xdata_family <- malaria[malaria$Host_family %in% family_reduced$Var1,]
Xdata_genus <- malaria[malaria$Host_genus %in% genus_reduced$Var1,]
Xdata_species <- malaria[malaria$Host_species %in% species_reduced$Var1,]

# Look at tables for chi-squared tests - within-genus co-infection
table(Xdata_order$Host_order, Xdata_order$any_coinf_within)
table(Xdata_family$Host_family, Xdata_family$any_coinf_within)
table(Xdata_genus$Host_genus, Xdata_genus$any_coinf_within)
table(Xdata_species$Host_species, Xdata_species$any_coinf_within)

# Look at tables for chi-squared tests - between-genus co-infection
table(Xdata_order$Host_order, Xdata_order$any_coinf_between)
table(Xdata_family$Host_family, Xdata_family$any_coinf_between)
table(Xdata_genus$Host_genus, Xdata_genus$any_coinf_between)
table(Xdata_species$Host_species, Xdata_species$any_coinf_between)

```

```{r}
order_hist <- ggplot(order_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#98cd59") +
              labs(x = "Order", y = NULL) +
              theme(axis.title.y = element_text(size = 12))
family_hist <- ggplot(family_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#2ebd63") +
              labs(x = "Family", y = NULL) +
              scale_x_continuous(limits = c(0,450)) +
              scale_y_continuous(limits = c(0,11)) +
              theme(axis.title.y = element_text(size = 12))
genus_hist <- ggplot(genus_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#10b7e5") +
              labs(x = "Genus", y = NULL) +
              scale_x_continuous(limits = c(0,450)) +
              scale_y_continuous(limits = c(0,45)) +
              theme(axis.title.y = element_text(size = 12))
species_hist <- ggplot(species_freqs, aes(Freq)) +
              geom_histogram(bins = 20, fill = "#0f8ac7") +
              labs(x = "Species", y = NULL) +
              scale_x_continuous(limits = c(0,450)) +
              scale_y_continuous(limits = c(0,70)) +
              theme(axis.title.y = element_text(size = 12))

tax_freq_hists <- grid.arrange(order_hist, family_hist, genus_hist, species_hist,
                               ncol = 1)
ggsave("taxonomical frequencies.png", tax_freq_hists, height = 4, width = 3)
```

#### Logistic regression: All orders, families, genera
```{r}
# Leucocytozoon
Lglm1 <- glm(leuco_coinf ~ I(Host_order), data = malaria, family = binomial)
summary(Lglm1)

Lglm2 <- glm(leuco_coinf ~ Host_family, data = malaria, family = binomial)
summary(Lglm2)

Lglm3 <- glm(leuco_coinf ~ Host_genus, data = malaria, family = binomial)
summary(Lglm3)

# Haemocrodius
Hglm1 <- glm(haemo_coinf ~ Host_order, data = malaria, family = binomial)
summary(Hglm1)

Hglm2 <- glm(haemo_coinf ~ Host_family, data = malaria, family = binomial)
summary(Hglm2)

Hglm3 <- glm(haemo_coinf ~ Host_genus, data = malaria, family = binomial)
summary(Hglm3)

# Plasmodium
Pglm1 <- glm(plas_coinf ~ Host_order, data = malaria, family = binomial)
summary(Pglm1)

Pglm2 <- glm(plas_coinf ~ Host_family, data = malaria, family = binomial)
summary(Pglm2)

Pglm3 <- glm(plas_coinf ~ Host_genus, data = malaria, family = binomial)
summary(Pglm3)

# Any infection
Aglm1 <- glm(any_coinf_within ~ Host_order, data = malaria, family = binomial)
summary(Aglm1)

Aglm2 <- glm(any_coinf_within ~ Host_family, data = malaria, family = binomial)
summary(Aglm2)

Aglm3 <- glm(any_coinf_within ~ Host_genus, data = malaria, family = binomial)
summary(Aglm3)

```

#### k-means Clustering
```{r}
any_coinf_order <- as.data.frame(prop.table(
  table(malaria$Host_order, malaria$any_coinf_within), 1))
any_coinf_order <- any_coinf_order[any_coinf_order$Var2=="1", c("Var1", "Freq")]
colnames(any_coinf_order) <- c("Order", "p_coinf")
kmeans(any_coinf_order$p_coinf, centers = 3)
plot(any_coinf_order$p_coinf, col = cl$cluster)

any_coinf_species <- as.data.frame(prop.table(
  table(malaria$Host_species, malaria$any_coinf_within), 1))
any_coinf_species <- any_coinf_species[any_coinf_species$Var2=="1", c("Var1", "Freq")]
colnames(any_coinf_species) <- c("Species", "p_coinf")
kmeans(any_coinf_species$p_coinf, centers = 3)
plot(any_coinf_species$p_coinf, cl$cluster)

Xsq <- chisq.test(table(malaria$Host_order, malaria$any_coinf_within))
```


## 4. Does the likelihood of co-infection vary by malaria lineages?

```{r}

```

