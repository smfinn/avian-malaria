---
title: "Consulting Avian Malaria"
author: "Sean Finn & Evelyn Lupancu"
date: "9/17/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggcorrplot)
library(grid)
library(gridExtra)
```

```{r}
malaria <- read_excel("MalariaSampling_MasterFile_Sept23.xlsx")

# Rename long variables
malaria <- malaria %>% rename(screened_l = `Screened for Leuco`,
                              screened_h = `Screened for HAEM`,
                              screened_p = `Screened for Plas`,
                              positive_l = `Positive=1...21`,
                              positive_h = `Positive=1...27`,
                              positive_p = `Positive=1...33`,
                              posdesig_l = `Pos Designation...22`,
                              posdesig_h = `Pos Designation...28`,
                              posdesig_p = `Pos Designation...34`)

# Change elevation, latitude, and longitude variables to numeric
malaria$Elevation <- str_remove_all(malaria$Elevation, "m")
malaria$Elevation <- as.numeric(malaria$Elevation)
malaria$Lat <- as.numeric(malaria$Lat)
malaria$Long <- as.numeric(malaria$Long)

# Standardize sex reporting
malaria$Sex[malaria$Sex == "f"] <- "F"
malaria$Sex[malaria$Sex == "m"] <- "M"
malaria$Sex[malaria$Sex == "?"] <- "X"
malaria$Sex[malaria$Sex == "N"] <- "X"
malaria$Sex[malaria$Sex == "0"] <- "X"
malaria$Sex[malaria$Sex == "No BS"] <- "X"
table(malaria$Sex)

# Convert negative test results to zeros
malaria <- malaria %>% mutate(positive_l = ifelse(is.na(positive_l), 0, 1),
                              positive_h = ifelse(is.na(positive_h), 0, 1),
                              positive_p = ifelse(is.na(positive_p), 0, 1))

# Shorten Democratic Republic of the Congo
malaria$Country[malaria$Country=="Democratic Republic Congo"] <- "DRC"
```

## Exploratory Data Analysis

```{r}
table(malaria$Country)
table(malaria$District)
hist(malaria$Elevation)
```

```{r}
elevation <- ggplot(malaria, aes(Elevation)) +
  geom_histogram(bins = 15, fill = "forestgreen") +
  labs(title = "Elevation of Avian Samples",
       x = "Elevation", y = "Frequency") +
  scale_x_continuous(limits = c(0, 3000)) +
  theme_classic()
elevation
```

#### Infections by country
```{r}
leuco.country <- as.data.frame(table(malaria$positive_l, malaria$Country))
leuco_eda1 <- ggplot(leuco.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer() +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

leuco_eda2 <- ggplot(leuco.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

leuco_eda <- grid.arrange(leuco_eda1, leuco_eda2, nrow = 1, 
             top = "Leucocytozoon Positivity by Country")
ggsave("leucocytozoon by country.png", leuco_eda, width = 7, height = 4)
```

```{r}
haemo.country <- as.data.frame(table(malaria$positive_h, malaria$Country))
haemo_eda1 <- ggplot(haemo.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 4) +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

haemo_eda2 <- ggplot(haemo.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 4, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

haemo_eda <- grid.arrange(haemo_eda1, haemo_eda2, nrow = 1, 
             top = "Haemocrodius Positivity by Country")
ggsave("haemocrodius by country.png", haemo_eda, width = 7, height = 4)
```

```{r}
plas.country <- as.data.frame(table(malaria$positive_p, malaria$Country))
plas_eda1 <- ggplot(plas.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 7) +
  labs(title = "Stacked", x = "Country", y = "Frequency") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

plas_eda2 <- ggplot(plas.country, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 7, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Country", y = NULL) +
  theme(axis.text.x = element_text(angle = 15),
        title = element_text(size = 9))

plas_eda <- grid.arrange(plas_eda1, plas_eda2, nrow = 1, 
             top = "Plasmodium Positivity by Country")
ggsave("plasmodium by country.png", plas_eda, width = 7, height = 4)
```

#### Infections by sex
```{r}
leuco.sex <- as.data.frame(table(malaria$positive_l[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
leuco_eda3 <- ggplot(leuco.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer() +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

leuco_eda4 <- ggplot(leuco.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

leuco_eda_sex <- grid.arrange(leuco_eda3, leuco_eda4, nrow = 1, 
             top = "Leucocytozoon Positivity by Sex")

ggsave("leucocytozoon by sex.png", leuco_eda_sex, width = 4, height = 3)
```

```{r}
haemo.sex <- as.data.frame(table(malaria$positive_h[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
haemo_eda3 <- ggplot(haemo.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 4) +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

haemo_eda4 <- ggplot(haemo.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 4, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

haemo_eda_sex <- grid.arrange(haemo_eda3, haemo_eda4, nrow = 1, 
             top = "Haemocrodius Positivity by Sex")
ggsave("haemocrodius by sex.png", haemo_eda_sex, width = 4, height = 3)
```

```{r}
plas.sex <- as.data.frame(table(malaria$positive_p[malaria$Sex != "X"], 
                                 malaria$Sex[malaria$Sex != "X"]))
plas_eda3 <- ggplot(plas.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "stack") +
  scale_fill_brewer(palette = 7) +
  labs(title = "Stacked", x = "Sex", y = "Frequency") +
  theme(legend.position = "none", 
        title = element_text(size = 9))

plas_eda4 <- ggplot(plas.sex, aes(Var2, Freq, group = Var1)) +
  geom_bar(aes(fill = Var1), stat = "identity",  position = "fill") +
  scale_fill_brewer(palette = 7, name = "Positivity") +
  labs(title = "Standardized (percent)", x = "Sex", y = NULL) +
  theme(title = element_text(size = 9))

plas_eda_sex <- grid.arrange(plas_eda3, plas_eda4, nrow = 1, 
             top = "Plasmodium Positivity by Sex")
ggsave("plasmodium by sex.png", plas_eda_sex, width = 4, height = 3)
```


## 1. How often do co-infections occur within the same genera of avian malarial pathogens? 

#### *Among birds who are infected*

```{r}
total_n <- 3418

# Leucocytozoon
sum(malaria$screened_l == "Yes")   # How many screened
sum(malaria$positive_l, na.rm = T) # How many positive 
sum(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, na.rm = T)  # Co-infections
(p_L <- 198 / 749)
n_L <- 749
ci_L.lower <- p_L - qnorm(0.975) * sqrt((p_L * (1 - p_L)) / n_L)
ci_L.upper <- p_L + qnorm(0.975) * sqrt((p_L * (1 - p_L)) / n_L)
cat("95% confidence interval: [", round(c(ci_L.lower, ci_L.upper)*100, 2), "]")

# Haemocrodius
sum(malaria$screened_h == "Yes")   # How many screened
sum(malaria$positive_h, na.rm = T) # How many positive 
sum(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, na.rm = T)  # Co-infections
(p_H <- 51 / 348)
n_H <- 348
ci_H.lower <- p_H - qnorm(0.975) * sqrt((p_H * (1 - p_H)) / n_H)
ci_H.upper <- p_H + qnorm(0.975) * sqrt((p_H * (1 - p_H)) / n_H)
cat("95% confidence interval: [", round(c(ci_H.lower, ci_H.upper)*100, 2), "]")

# Plasmodium
sum(malaria$screened_p == "Yes")   # How many screened
sum(malaria$positive_p, na.rm = T) # How many positive 
sum(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, na.rm = T)  # Co-infections
(p_P <- 166 / 761)
n_P <- 761
ci_P.lower <- p_P - qnorm(0.975) * sqrt((p_P * (1 - p_P)) / n_P)
ci_P.upper <- p_P + qnorm(0.975) * sqrt((p_P * (1 - p_P)) / n_P)
cat("95% confidence interval: [", round(c(ci_P.lower, ci_P.upper)*100, 2), "]")
```

Leucocytozoon: [23.28%, 29.59%]
Haemocrodius: [10.94%, 18.37%]
Plasmodium: [18.88%, 24.75%]

```{r}
genera <- c("Leucocytozoon", "Haemocrodius", "Plasmodium")
y <- c(p_L*100, p_H*100, p_P*100)
ymin <- c(ci_L.lower*100, ci_H.lower*100, ci_P.lower*100)
ymax <- c(ci_L.upper*100, ci_H.upper*100, ci_P.upper*100)
wald_boxes <- as.data.frame(cbind(genera, y, ymin, ymax))
wald_boxes <- wald_boxes %>% mutate(y = as.numeric(y),
                                    ymin = as.numeric(ymin),
                                    ymax = as.numeric(ymax))

wald_boxes_chart <- ggplot(wald_boxes, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 30)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Frequency of Malaria Infection Frequency by Genus", 
       subtitle = "Among birds infected with genus",
       x = "Genus", y = "Percent of birds infected")
wald_boxes_chart

ggsave("frequency by genus1.png", wald_boxes_chart, height = 4.5, width = 5)
```


#### *Among all birds screened*

```{r}
total_n <- 3418

# Leucocytozoon
num_screened_l <- sum(malaria$screened_l == "Yes")   # How many screened
sum(malaria$posdesig_l == 2 | malaria$posdesig_l == 3, na.rm = T)  # Co-infections
(p2_L <- 198 / num_screened_l)
ci2_L.lower <- p2_L - qnorm(0.975) * sqrt((p2_L * (1 - p2_L)) / num_screened_l)
ci2_L.upper <- p2_L + qnorm(0.975) * sqrt((p2_L * (1 - p2_L)) / num_screened_l)
cat("95% confidence interval: [", round(c(ci2_L.lower, ci2_L.upper)*100, 2), "]")

# Haemocrodius
sum(malaria$posdesig_h == 2 | malaria$posdesig_h == 3, na.rm = T)  # Co-infections
(p2_H <- 51 / total_n)
ci2_H.lower <- p2_H - qnorm(0.975) * sqrt((p2_H * (1 - p2_H)) / total_n)
ci2_H.upper <- p2_H + qnorm(0.975) * sqrt((p2_H * (1 - p2_H)) / total_n)
cat("95% confidence interval: [", round(c(ci2_H.lower, ci2_H.upper)*100, 2), "]")

# Plasmodium
sum(malaria$posdesig_p == 2 | malaria$posdesig_p == 3, na.rm = T)  # Co-infections
(p2_P <- 166 / total_n)
ci2_P.lower <- p2_P - qnorm(0.975) * sqrt((p2_P * (1 - p2_P)) / total_n)
ci2_P.upper <- p2_P + qnorm(0.975) * sqrt((p2_P * (1 - p2_P)) / total_n)
cat("95% confidence interval: [", round(c(ci2_P.lower, ci2_P.upper)*100, 2), "]")
```

```{r}
genera <- c("Leucocytozoon", "Haemocrodius", "Plasmodium")
y2 <- c(p2_L*100, p2_H*100, p2_P*100)
ymin2 <- c(ci2_L.lower*100, ci2_H.lower*100, ci2_P.lower*100)
ymax2 <- c(ci2_L.upper*100, ci2_H.upper*100, ci2_P.upper*100)
wald_boxes2 <- as.data.frame(cbind(genera, y2, ymin2, ymax2))
wald_boxes2 <- wald_boxes %>% mutate(y = as.numeric(y2),
                                    ymin = as.numeric(ymin2),
                                    ymax = as.numeric(ymax2))

wald_boxes_chart2 <- ggplot(wald_boxes2, aes(genera, y)) +
  geom_pointrange(aes(x = genera, y = y, ymin = ymin, ymax = ymax,
                      color = genera),
                  fatten = 2.5, size = 1.5) +
  scale_y_continuous(limits = c(0, 8)) +
  scale_color_manual(values = c("#1e7898", "#86b191", "#e49d60")) +
  theme(legend.position = "none") +
  labs(title = "Frequency of Malaria Infection Frequency by Genus", 
       subtitle = "Among birds screened for genus", 
       x = "Genus", y = "Percent of birds infected")
wald_boxes_chart2

ggsave("frequency by genus2.png", wald_boxes_chart2, height = 4.5, width = 5)
```

Compare with using the negative binomial distribution for confidence intervals

#### Bootstrapping: Among infected birds

```{r}

```



#### Bootstrapping: Among screened birds

```{r}

```



## 2. How often do co-infections occur between different genera of avian malarial pathogens?

*Among birds that tested positive for malaria*

```{r}
sum(malaria$positive_l == 1 | malaria$positive_h == 1 | malaria$positive_p == 1, na.rm = T)
sum((malaria$positive_l == 1 & malaria$positive_h == 1) | 
    (malaria$positive_l == 1 & malaria$positive_p == 1) |
    (malaria$positive_h == 1 & malaria$positive_p == 1), na.rm = T)
p3 <- 306 / 1540
ci3.lower <- p3 - qnorm(0.975) * sqrt((p3 * (1 - p3)) / screened_all)
ci3.upper <- p3 + qnorm(0.975) * sqrt((p3 * (1 - p3)) / screened_all)
cat("95% confidence interval: [", round(c(ci3.lower, ci3.upper)*100, 2), "]")
```

*Among all birds screened*

```{r}
screened_all <- 3086
sum(malaria$posdesig_l == 4 | malaria$posdesig_h == 4 | malaria$posdesig_p == 4, na.rm = T)
p4 <- 77 / screened_all
ci4.lower <- p4 - qnorm(0.975) * sqrt((p4 * (1 - p4)) / screened_all)
ci4.upper <- p4 + qnorm(0.975) * sqrt((p4 * (1 - p4)) / screened_all)
cat("95% confidence interval: [", round(c(ci4.lower, ci4.upper)*100, 2), "]")
```


## 3. Are certain host birds more susceptible to co-infections than other hosts?

Start by looking into: Species, genus, family level
Remove groups that have less than 3 individuals, 5 individuals, 10 individuals - see what results look like
Pseudo-count (for many zeros in data) - look into this
Zero-inflated distributions, try other distributions

OUTCOME VARIABLE: Co-infection present (binary)
MODEL IDEAS:
- multivariate logistic regression
  + elastic net
  + main outcome variable: species/genus/family (categorical)
  + would need to remove groups with low counts, not enough confidence

OUTCOME VARIABLE: Co-infection rate by species/genus/family
MODEL IDEAS:
- Clustering
- Prediction of co-infection with random forest using family co-infection rate as predictor
- Zero-inflated Beta regression

Look into nested models... (but are there enough obs in genus, species?)

```{r}
length(unique(malaria$Host_family))
length(unique(malaria$Host_genus))
length(unique(malaria$Host_species))

malaria %>% group_by(Host_family) %>% summarize(Count = n()) %>% arrange(desc(Count))
malaria %>% group_by(Host_genus) %>% summarize(Count = n()) %>% arrange(desc(Count))
malaria %>% group_by(Host_species) %>% summarize(Count = n()) %>% arrange(desc(Count))
```

## 4. Does the likelihood of co-infection vary by malaria lineages?

```{r}

```

